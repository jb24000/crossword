<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NES Crossword">
  <meta name="application-name" content="NES Crossword">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>🎮 NES Crossword 🎮</title>
  <style>
    body { font-family: monospace, 'Courier New', Courier; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background 0.4s, color 0.4s; }
    .container { max-width: 480px; margin: 0 auto; background: rgba(0,0,0,0.4); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 -20px 40px rgba(0,0,0,0.3); padding: 32px 18px 24px 18px; display: flex; flex-direction: column; align-items: center; }
    .title { font-size: 24px; color: #00ff88; margin-bottom: 10px; font-weight: bold; text-shadow: 2px 2px 0px #000; letter-spacing: 1px; text-align: center; }
    .toggles { display: flex; justify-content: center; gap: 24px; margin-bottom: 18px; }
    .switch { position:relative; display:inline-block; width:50px; height:24px; }
    .switch input{display:none;}
    .slider { position:absolute; top:0; left:0; right:0; bottom:0; background:#ccc; border-radius:34px; transition:.4s; cursor: pointer; }
    .slider:before { content:""; position:absolute; width:18px; height:18px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.4s; }
    input:checked+.slider { background:#00ff88; }
    input:checked+.slider:before { transform:translateX(26px); }
    .settings-label { font-size: 14px; color: #FFD700; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; text-align: center; }
    .lobby-form { display: flex; flex-direction: column; gap: 14px; width: 100%; align-items: center; }
    .lobby-form input, .lobby-form select { font-size: 16px; padding: 7px; border-radius: 8px; border: none; background: #f8f9fa; color: #222; width: 80%; max-width: 260px; margin: 0 auto; box-sizing: border-box; }
    .lobby-form label { font-size: 13px; color: #fff; margin-bottom: 2px; text-align: left; width: 80%; max-width: 260px; }
    .mode-buttons { display: flex; gap: 16px; margin-top: 10px; justify-content: center; }
    .mode-button { font-size: 16px; padding: 12px 20px; border: none; border-radius: 8px; background: #00ff88; color: #333; font-weight: bold; cursor: pointer; margin: 0 4px; transition: background 0.2s; }
    .mode-button:hover { background: #00cc6a; }
    .hidden { display: none !important; }
    #player2-section { display: flex; flex-direction: column; align-items: center; width: 100%; }
    #player2-section label, #player2-section input { width: 80%; max-width: 260px; }
    #back-to-one { margin-top: 8px; background: #00ff88; color: #222; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: bold; font-size: 14px; width: 80%; max-width: 260px; }
    #back-to-one:hover { background: #00cc6a; }
    .music-controls { display: flex; gap: 6px; margin-top: 8px; margin-bottom: 12px; justify-content: center; }
    .music-controls button { font-family: monospace, 'Courier New', Courier; font-size: 12px; padding: 6px 10px; border: none; border-radius: 6px; background: #00ff88; color: #222; font-weight: bold; cursor: pointer; transition: background 0.2s; }
    .music-controls button:hover { background: #00cc6a; }
    
    /* Timer mode toggle */
    .timer-mode-container { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 15px; }
    .timer-mode-toggle { display: flex; gap: 12px; align-items: center; }
    .timer-mode-label { font-size: 12px; color: #FFD700; font-weight: bold; }
    
    #game-area { display: none; width: 100%; max-width: 600px; margin: 20px auto; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); text-align: center; position: relative; }
    #hud { margin: 10px; font-size: 12px; color: #FFD700; background: rgba(0,0,0,0.4); padding: 6px 12px; border-radius: 8px; border: 2px solid #FFD700; box-shadow: 2px 2px 0px #333; display: inline-block; }
    #crossword { display: grid; gap: 1px; background: #333; margin: 20px auto; padding: 8px; border: 4px solid #FFD700; border-radius: 12px; box-shadow: inset 4px 4px 0px #555, 4px 4px 0px #666; justify-content: center; width: fit-content; }
    .cell { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #ffffff; color: #000; font-size: 14px; border: 2px solid #333; position: relative; cursor: pointer; font-weight: bold; box-shadow: inset -2px -2px 0px #bbb, inset 2px 2px 0px #fff; transition: background 0.2s, transform 0.1s; }
    .cell:hover { transform: scale(1.05); }
    .black { background: #111 !important; border: 2px solid #000 !important; box-shadow: inset -2px -2px 0px #000 !important; cursor: default; }
    .black:hover { transform: none; }
    .clue-number { font-size: 8px; position: absolute; top: 1px; left: 2px; color: #444; }
    .highlight { background: #FFD700 !important; color: #222 !important; animation: pulse 0.5s ease-in-out; }
    .active { outline: 2px solid #00ff88; animation: glow 1s ease-in-out infinite alternate; }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 5px #00ff88; }
      to { box-shadow: 0 0 20px #00ff88, 0 0 30px #00ff88; }
    }
    
    .clues { display: grid; grid-template-columns: 1fr 1fr; width: 90%; max-width: 600px; margin: 20px auto; gap: 20px; font-size: 11px; }
    .clue-list { background: rgba(0,0,0,0.5); border: 2px solid #FFD700; border-radius: 10px; padding: 10px; box-shadow: 3px 3px 0px #000; }
    .clue-list h3 { margin-bottom: 8px; font-size: 13px; color: #FFD700; border-bottom: 1px solid #FFD700; padding-bottom: 4px; text-align: center; }
    .clue-list ul { padding: 0; margin: 0; list-style: none; }
    .clue-list li { margin-bottom: 8px; line-height: 1.4; cursor: pointer; transition: color 0.2s; padding: 4px; border-radius: 4px; }
    .clue-list li:hover { color: #00ff88; background: rgba(0,255,136,0.1); }
    .clue-list li.solved { color: #888; text-decoration: line-through; }
    .game-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
    .game-buttons button { padding: 10px 15px; font-size: 14px; cursor: pointer; border-radius: 8px; border: none; background: #00ff88; color: #222; font-weight: bold; transition: background 0.2s, transform 0.1s; }
    .game-buttons button:hover { background: #00cc6a; transform: translateY(-2px); }
    .game-buttons button:active { transform: translateY(0); }
    .fade-black { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); color: #FFD700; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 2rem; opacity: 0; pointer-events: none; transition: opacity 0.7s; }
    .fade-black.show { opacity: 1; pointer-events: all; }
    .player-turn-display { font-size: 18px; color: #00ff88; margin-bottom: 10px; font-weight: bold; }
    .high-score-display { font-size: 14px; color: #FFD700; margin-top: 5px; }
    .leaderboard { text-align: center; margin-top: 18px; }
    .leaderboard-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #FFD700; border-bottom: 2px solid #FFD700; display: inline-block; padding-bottom: 4px; letter-spacing: 1px; }
    .tabs { display: flex; justify-content: center; margin-bottom: 10px; gap: 8px; }
    .tab { padding: 6px 12px; cursor: pointer; border-bottom: 3px solid transparent; color: #fff; font-weight: normal; border-radius: 4px 4px 0 0; background: none; transition: color 0.2s; font-size: 12px; }
    .tab.active { border-color: #FFD700; font-weight: bold; color: #FFD700; background: rgba(255,255,255,0.05); }
    .leaderboard ul { list-style: none; padding: 0; margin: 0; }
    .leaderboard li { margin: 5px 0; font-size: 12px; color: #fff; font-weight: normal; }
    #mobile-input { position: absolute; top: -9999px; left: -9999px; opacity: 0; z-index: -1; font-size: 16px; width: 1px; height: 1px; border: none; background: transparent; color: transparent; outline: none; resize: none; }
    
    /* Virtual Keyboard Styles */
    .keyboard { 
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background: rgba(0,0,0,0.9);
      padding: 15px 10px 10px 10px;
      user-select: none; 
      z-index: 1000;
      border-top: 3px solid #FFD700;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .keyboard.docked {
      transform: translateY(80%);
    }
    .keyboard-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 0 10px;
    }
    .keyboard-title {
      color: #FFD700;
      font-size: 14px;
      font-weight: bold;
      margin: 0;
    }
    .keyboard-controls {
      display: flex;
      gap: 10px;
    }
    .keyboard-control-btn {
      width: 32px;
      height: 32px;
      border: 2px solid #FFD700;
      background: #333;
      color: #FFD700;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .keyboard-control-btn:hover {
      background: #555;
    }
    .keyboard-control-btn:active {
      background: #FFD700;
      color: #333;
    }
    .keyboard-row { 
      display: flex; 
      justify-content: center; 
      margin: 3px 0; 
      gap: 4px;
    }
    .keyboard-row button { 
      width: 36px; 
      height: 36px; 
      border: 2px solid #FFD700; 
      background: #333; 
      color: #00ff88; 
      font-family: monospace, 'Courier New', Courier; 
      font-size: 16px; 
      cursor: pointer; 
      border-radius: 6px; 
      font-weight: bold; 
      transition: all 0.15s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .keyboard-row button:hover { 
      background: #555; 
      transform: translateY(-1px);
    }
    .keyboard-row button:active { 
      background: #00ff88; 
      color: #333; 
      transform: translateY(1px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .keyboard-row button#delete {
      width: 50px;
      font-size: 18px;
      background: #cc3333;
      border-color: #ff6666;
    }
    .keyboard-row button#delete:hover {
      background: #dd4444;
    }
    .keyboard-row button#delete:active {
      background: #ff6666;
      color: #fff;
    }

    /* Light mode styles */
    body.light-mode { background: linear-gradient(135deg, #f8f9fa 0%, #e2e8f0 100%); color: #495057; }
    .container.light-mode, #game-area.light-mode { background: rgba(255,255,255,0.9); color: #495057; }
    .settings-label.light-mode { color: #495057; }
    .title.light-mode { color: #00ff88; text-shadow: 2px 2px 0px #fff; }
    .lobby-form input.light-mode, .lobby-form select.light-mode { background: #fff; color: #495057; border: 1px solid #adb5bd; }
    .lobby-form label.light-mode { color: #495057; }
    .timer-mode-label.light-mode { color: #495057; }
    #hud.light-mode { color: #495057; border-color: #495057; background: rgba(255,255,255,0.8); box-shadow: 2px 2px 0px #adb5bd; }
    #crossword.light-mode { background: #adb5bd; border-color: #495057; box-shadow: inset 4px 4px 0px #6c757d, 4px 4px 0px #dee2e6; }
    .cell.light-mode { background: #ffffff; color: #495057; border-color: #6c757d; box-shadow: inset -2px -2px 0px #dee2e6, inset 2px 2px 0px #fff; }
    .black.light-mode { background: #6c757d !important; border-color: #495057 !important; box-shadow: inset -2px -2px 0px #495057 !important; }
    .clue-number.light-mode { color: #6c757d; }
    .highlight.light-mode { background: #FFD700 !important; color: #495057 !important; }
    .active.light-mode { outline: 3px solid #00ff88; }
    .clue-list.light-mode { background: rgba(255,255,255,0.9); border-color: #495057; box-shadow: 3px 3px 0px #adb5bd; }
    .clue-list h3.light-mode { color: #495057; border-color: #495057; }
    .clue-list li.light-mode { color: #495057; }
    .clue-list li.light-mode:hover { color: #00ff88; background: rgba(0,255,136,0.1); }
    .player-turn-display.light-mode { color: #00ff88; }
    .high-score-display.light-mode { color: #495057; }
    .leaderboard-title.light-mode { color: #495057; border-color: #495057; }
    .tab.light-mode { color: #495057; }
    .tab.active.light-mode { border-color: #FFD700; color: #FFD700; background: rgba(0,0,0,0.05); }
    .leaderboard li.light-mode { color: #495057; }
    .toggles label.light-mode { color: #495057; }
    
    /* Light mode keyboard */
    .keyboard.light-mode { 
      background: rgba(255,255,255,0.95); 
      border-color: #495057; 
    }
    .keyboard-title.light-mode {
      color: #495057;
    }
    .keyboard-control-btn.light-mode {
      border-color: #495057;
      background: #fff;
      color: #495057;
    }
    .keyboard-control-btn.light-mode:hover {
      background: #f8f9fa;
    }
    .keyboard-control-btn.light-mode:active {
      background: #495057;
      color: #fff;
    }
    .keyboard-row button.light-mode { 
      border-color: #495057; 
      background: #fff; 
      color: #495057; 
    }
    .keyboard-row button.light-mode:hover { 
      background: #f8f9fa; 
    }
    .keyboard-row button.light-mode:active { 
      background: #495057; 
      color: #fff; 
    }
    .keyboard-row button#delete.light-mode {
      background: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }
    .keyboard-row button#delete.light-mode:hover {
      background: #c82333;
    }

    /* Mobile responsive */
    @media (max-width: 600px) {
      .container { 
        margin: 10px; 
        padding: 18px 15px 12px 15px; 
        width: calc(100% - 20px); 
        max-width: none; 
      }
      .title { font-size: 18px; }
      .toggles { gap: 15px; margin-bottom: 15px; }
      .toggles label { display: flex; align-items: center; gap: 8px; font-size: 11px; }
      .music-controls { justify-content: center; margin-top: 8px; margin-bottom: 12px; gap: 6px; }
      .music-controls button { font-size: 9px; padding: 6px 8px; }
      .mode-buttons { flex-wrap: wrap; gap: 8px; }
      .mode-button { flex: 1; min-width: 120px; font-size: 14px; }
      .leaderboard-title { font-size: 12px; }
      .tab { font-size: 10px; padding: 6px 8px; }
      .leaderboard li { font-size: 9px; }
      
      #game-area { 
        margin: 10px; 
        padding: 15px 15px 120px 15px;
        width: calc(100% - 20px); 
        max-width: none; 
      }
      .cell { width: 28px; height: 28px; font-size: 12px; }
      .clue-number { font-size: 6px; }
      .clues { grid-template-columns: 1fr; gap: 12px; }
      .clue-list h3 { font-size: 11px; }
      .clue-list li { font-size: 9px; line-height: 1.5; }
      .game-buttons { flex-wrap: wrap; gap: 6px; margin-top: 10px; }
      .game-buttons button { padding: 8px 12px; font-size: 11px; flex: 1; min-width: 100px; }
      #hud { font-size: 9px; padding: 6px 8px; word-break: break-word; }
      .player-turn-display { font-size: 14px; }
      .high-score-display { font-size: 11px; }
      
      .keyboard-row button { 
        width: 32px; 
        height: 32px; 
        font-size: 14px; 
      }
      .keyboard-row button#delete {
        width: 45px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
<div class="container" id="lobby">
  <div class="title" id="title">🎮 NES Crossword 🎮</div>
  <div class="toggles">
    <label>🌙 Dark
      <label class="switch">
        <input type="checkbox" id="darkToggle" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>🔊 Sound
      <label class="switch">
        <input type="checkbox" id="soundToggle">
        <span class="slider"></span>
      </label>
    </label>
  </div>
  <div class="music-controls">
    <button id="prev-track">⏮ Prev</button>
    <button id="next-track">Next ⏭</button>
  </div>

  <!-- YouTube Music Embed (hidden by default) -->
  <div id="music-player" style="width:0;height:0;overflow:hidden;">
    <iframe id="yt-music" width="0" height="0" frameborder="0" allow="autoplay; encrypted-media" src=""></iframe>
  </div>

  <div class="settings-label" id="settings-label">SETTINGS</div>
  
  <!-- Timer Mode Toggle -->
  <div class="timer-mode-container">
    <div class="timer-mode-label">Game Mode</div>
    <div class="timer-mode-toggle">
      <label class="timer-mode-label">⏱️ Timed
        <label class="switch">
          <input type="checkbox" id="timerToggle" checked>
          <span class="slider"></span>
        </label>
      </label>
    </div>
  </div>
  
  <form class="lobby-form" id="lobby-form" onsubmit="return false;">
    <label for="player1-name">Player 1 Name:</label>
    <input type="text" id="player1-name" placeholder="Player 1" required />
    <div id="player2-section" class="hidden">
      <label for="player2-name">Player 2 Name:</label>
      <input type="text" id="player2-name" placeholder="Player 2" />
      <button type="button" id="back-to-one">Back to Player 1</button>
    </div>
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty">
      <option value="kids">Kids</option>
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
    <div class="mode-buttons">
      <button class="mode-button" id="start-single">Start Game</button>
      <button class="mode-button" id="start-two">2-Player Mode</button>
    </div>
  </form>
  <div class="leaderboard">
    <div class="leaderboard-title">Leaderboard</div>
    <div class="tabs">
      <div class="tab" onclick="switchTab('kids')">Kids</div>
      <div class="tab" onclick="switchTab('easy')">Easy</div>
      <div class="tab active" onclick="switchTab('medium')">Medium</div>
      <div class="tab" onclick="switchTab('hard')">Hard</div>
    </div>
    <ul id="leaderboard-list"></ul>
  </div>
</div>
<div id="game-area">
  <input type="text" id="mobile-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <div class="player-turn-display" id="player-turn-display"></div>
  <div id="hud">Score: 0 | Time: 0 | Words: 0</div>
  <div class="high-score-display" id="high-score-display">High Score: 0</div>
  <div id="crossword"></div>
  <div class="clues">
    <div class="clue-list" id="across-clues">
      <h3>Across</h3>
      <ul></ul>
    </div>
    <div class="clue-list" id="down-clues">
      <h3>Down</h3>
      <ul></ul>
    </div>
  </div>
  <div class="game-buttons">
    <button onclick="useHint()">Get Hint</button>
    <button onclick="checkPuzzle()">Check Puzzle</button>
    <button onclick="revealPuzzle()">Reveal Puzzle</button>
    <button onclick="backToLobby()">🏠 Back to Lobby</button>
  </div>
</div>
<div class="fade-black" id="fade-black"></div>
<audio id="win-sound" src="win.mp3" preload="auto"></audio>
<audio id="lose-sound" src="lose.mp3" preload="auto"></audio>

<div id="virtual-keyboard" class="keyboard hidden">
  <div class="keyboard-header">
    <div class="keyboard-title">Virtual Keyboard</div>
    <div class="keyboard-controls">
      <button class="keyboard-control-btn" id="dock-keyboard" title="Dock/Undock">⇅</button>
      <button class="keyboard-control-btn" id="close-keyboard" title="Close">✕</button>
    </div>
  </div>
  <div class="keyboard-row">
    <button data-key="Q">Q</button><button data-key="W">W</button><button data-key="E">E</button><button data-key="R">R</button><button data-key="T">T</button><button data-key="Y">Y</button><button data-key="U">U</button><button data-key="I">I</button><button data-key="O">O</button><button data-key="P">P</button>
  </div>
  <div class="keyboard-row">
    <button data-key="A">A</button><button data-key="S">S</button><button data-key="D">D</button><button data-key="F">F</button><button data-key="G">G</button><button data-key="H">H</button><button data-key="J">J</button><button data-key="K">K</button><button data-key="L">L</button>
  </div>
  <div class="keyboard-row">
    <button data-key="Z">Z</button><button data-key="X">X</button><button data-key="C">C</button><button data-key="V">V</button><button data-key="B">B</button><button data-key="N">N</button><button data-key="M">M</button>
    <button id="delete" data-key="Backspace">⌫</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Music playlist
  const playlist = [
    "fs0BCIUQ7Ws", // NES Track 1
    "VpqoE7ft284", // NES Track 2
    "TfEZaH_BBLY", // NES Track 3
    "V6SJzeegnck", // NES Track 4
    "pzkAKQJv19A", // NES Track 5
    "CIWo9e1Qzos", // NES Track 6
    "WvzVYC507gU"  // NES Track 7
  ];
  let currentTrackIndex = 0;
  let musicStarted = false;

  // --- FIXED: Cleaned Word Banks with NO duplicates and proper difficulty assignment ---
  const wordBanks = {
    kids: [
      'cat','dog','sun','car','toy','red','big','fun','hat','mom','dad','boy','run','eat','yes','zoo',
      'balloon','puzzle','rocket','pirate','castle','jungle','monster','rainbow','penguin','blanket',
      'tractor','diamond','pumpkin','treasure','dolphin','picture','pancake','popcorn','unicorn','scooter',
      'backpack','crystal','fortune','journey','lantern','marbles','octopus','parasol','peacock','pretzel',
      'skating','snowman','tornado','trouble','whistle','sandbox','mailbox','cabinet','mailman'
    ],
    easy: [
      'animal','basket','button','dinner','eleven','frozen','garden','happy','island','jacket','kitchen',
      'ladder','monkey','number','orange','pencil','rabbit','school','turtle','uncle','valley','window',
      'yellow','zebra','answer','branch','cloudy','donkey','enough','flower','ground','hungry','inside',
      'kitten','letter','middle','nephew','pickle','ribbon','simple','things','upward','violet','waffle',
      'yogurt','zipper','always','banana','candle','doctor','engine','finger','handle','kindly','listen',
      'market','nature','office','person','quarter','reason','summer','turkey','united','violin','winter',
      'yearly','zombie','apples','bottle','circle','laptop','mouse','screen','coffee','remote','charge',
      'energy','family','friend','memory','silver','golden','planet','travel','teacher','student','library',
      'eraser','marker','supply','lesson','future','dreams','clouds','light','spring','autumn','forest',
      'desert','river','ocean','giraffe','panda','whale','sharks','eagles','wolves','foxes','chicken',
      'soccer','dragon','wizard','galaxy','meteor','comet','corner','falcon','helmet','insect','jigsaw',
      'recipe','spider','vacuum','walrus','yonder'
    ],
    medium: [
      'october','quiver','iguana','notebook','printer','holiday','thunder','mountain','valleys','baseball',
      'hockey','volcano','spaceship','science','python','variable','function','object','array','coding',
      'server','internet','network','amazon','google','github','docker','oyster','quartz','earwig',
      'kneads','quotas','vulcan','quiche','football','junkyard','enormous','graceful','horrible','jealousy',
      'kindness','nonsense','obtained','pleasant','quarters','recently','skeleton','triangle','universe',
      'villager','yourself','glorious','haunting','inventor','jokester','keyboard','nautical','observed',
      'princess','quantity','whistled','brilliant','decision','judgment','research','solution','variety',
      'accepted','graphics','harmony','machine','remarks','violent','boundary','document','historic',
      'journal','knuckle','quilts','xylose','zipped','approx','xenial','afraid','before','chance',
      'during','gentle','higher','indeed','locker','modern','native','option','profit','quarry',
      'result','stream','tribal','unfold','victor','xenons','zephyr','action','choice','defeat',
      'entire','global','hushed','injury','joyful','lovely','medium','narrow','openly','pocket',
      'quotes','relate','sector','treaty','unable','vector','warmth','xylem','yields','accord'
    ],
    hard: [
      'champion','astronaut','javascript','terraform','lambda','elephant','basketball','acknowledge',
      'architecture','biodiversity','championship','demographic','exponential','fluctuation','gravitational',
      'hierarchical','implementation','juxtaposition','kaleidoscope','logarithmic','metamorphosis',
      'neurological','optimization','philosophical','questionnaire','revolutionary','sophisticated',
      'technological','uncomfortable','vulnerability','xylophone','zenith','absorption','calibration',
      'democratization','entrepreneurship','functionality','globalization','hospitalization','industrialization',
      'justification','liberalization','maximization','normalization','operationalization','personalization',
      'quantification','rationalization','standardization','transformation','urbanization','visualization',
      'westernization','xerophyte','yesteryear','zygote'
    ]
  };
 
  // --- Game State Variables ---
  let player1Name = '', player2Name = '', currentDifficulty = 'medium';
  let isTwoPlayerMode = false, currentPlayer = 1;
  let player1Score = 0, player2Score = 0, currentPuzzleScore = 0;
  let currentPuzzleWordsCompleted = 0, currentPuzzleTotalWords = 0;
  let timeLeft = 0, timerInterval, freeHintUsed = false, gameOver = false;
  let currentHighScore = 0, leaderboards = {};
  let isTimedMode = true; // NEW: Timer mode toggle
  
  if (typeof(Storage) !== "undefined" && localStorage) {
    leaderboards = JSON.parse(localStorage.getItem('crosswordLeaderboards') || '{}');
  }
  if (!leaderboards.kids) leaderboards.kids = [];
  if (!leaderboards.easy) leaderboards.easy = [];
  if (!leaderboards.medium) leaderboards.medium = [];
  if (!leaderboards.hard) leaderboards.hard = [];
  let currentLeaderboardTab = 'medium';

  // --- UI Elements ---
  const lobbyDiv = document.getElementById('lobby');
  const gameAreaDiv = document.getElementById('game-area');
  const player1NameInput = document.getElementById('player1-name');
  const player2NameInput = document.getElementById('player2-name');
  const difficultySelect = document.getElementById('difficulty');
  const player2Section = document.getElementById('player2-section');
  const backToOneButton = document.getElementById('back-to-one');
  const hudDisplay = document.getElementById('hud');
  const highScoreDisplay = document.getElementById('high-score-display');
  const playerTurnDisplay = document.getElementById('player-turn-display');
  const darkToggle = document.getElementById('darkToggle');
  const soundToggle = document.getElementById('soundToggle');
  const timerToggle = document.getElementById('timerToggle'); // NEW: Timer toggle
  const winSound = document.getElementById('win-sound');
  const loseSound = document.getElementById('lose-sound');
  const mobileInput = document.getElementById('mobile-input');
  const virtualKeyboard = document.getElementById('virtual-keyboard');

  let gridSize, solutionGrid, playerGrid, wordsMap = [], clueCounter = 1;
  let activeWord = null, activeCellIndex = 0;

  // --- Theme and Sound Toggles ---
  if (typeof(Storage) !== "undefined" && localStorage) {
    if (!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark');
    if (!localStorage.getItem('sound')) localStorage.setItem('sound', 'off');
    if (!localStorage.getItem('timerMode')) localStorage.setItem('timerMode', 'true');
    darkToggle.checked = localStorage.getItem('theme') === 'dark';
    soundToggle.checked = localStorage.getItem('sound') === 'on';
    timerToggle.checked = localStorage.getItem('timerMode') === 'true';
    isTimedMode = timerToggle.checked;
  } else {
    darkToggle.checked = true;
    soundToggle.checked = false;
    timerToggle.checked = true;
    isTimedMode = true;
  }
  setTheme(darkToggle.checked ? 'dark' : 'light');

  // Event listeners for toggles
  darkToggle.addEventListener('change', function () {
    setTheme(this.checked ? 'dark' : 'light');
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('theme', this.checked ? 'dark' : 'light');
    }
    showFade(this.checked ? '🌙 Dark Mode ON' : '☀️ Light Mode ON');
  });

  soundToggle.addEventListener('change', function () {
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('sound', this.checked ? 'on' : 'off');
    }
    handleSoundToggle(this.checked);
    showFade(this.checked ? '🔊 Sound ON' : '🔇 Sound OFF');
  });

  // NEW: Timer mode toggle
  timerToggle.addEventListener('change', function () {
    isTimedMode = this.checked;
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('timerMode', this.checked ? 'true' : 'false');
    }
    showFade(this.checked ? '⏱️ Timed Mode ON' : '∞ Unlimited Mode ON');
  });

  // Music functions
  let musicInitialized = false;

  function handleSoundToggle(soundOn) {
    if (soundOn) {
      showFade('🔊 Sound ON - Click anywhere to start music!');
    } else {
      const iframe = document.getElementById('yt-music');
      if (iframe) {
        iframe.src = '';
      }
      musicStarted = false;
      musicInitialized = false;
      showFade('🔇 Sound OFF');
    }
  }

  function initializeMusic() {
    if (!soundToggle.checked || musicInitialized) return;
    musicInitialized = true;
    loadTrack(0);
    showFade('🎵 Music Starting!');
  }

  function loadTrack(index) {
    if (!soundToggle.checked) return;
    currentTrackIndex = (index + playlist.length) % playlist.length;
    const videoId = playlist[currentTrackIndex];
    const iframe = document.getElementById('yt-music');
    if (!iframe) return;
    const newSrc = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=0&controls=0&mute=0&enablejsapi=1&origin=${window.location.origin}&rel=0&start=0`;
    iframe.src = newSrc;
    musicStarted = true;
    createBeepSound(600, 150);
    showFade(`🎵 Track ${currentTrackIndex + 1}: Loading...`);
  }

  function changeTrack(direction) {
    if (!soundToggle.checked) {
      showFade('🔇 Turn on sound first!');
      return;
    }
    if (!musicInitialized) {
      initializeMusic();
      return;
    }
    currentTrackIndex = (currentTrackIndex + direction + playlist.length) % playlist.length;
    loadTrack(currentTrackIndex);
  }

  document.addEventListener('click', function(e) {
    if (soundToggle.checked && !musicInitialized) {
      initializeMusic();
    }
  }, { once: false });

  document.getElementById('prev-track').addEventListener('click', () => changeTrack(-1));
  document.getElementById('next-track').addEventListener('click', () => changeTrack(1));

  function setTheme(mode) {
    document.body.classList.toggle('light-mode', mode === 'light');
    lobbyDiv.classList.toggle('light-mode', mode === 'light');
    gameAreaDiv.classList.toggle('light-mode', mode === 'light');
    virtualKeyboard.classList.toggle('light-mode', mode === 'light');
    
    document.querySelectorAll('.keyboard-control-btn').forEach(el => {
      el.classList.toggle('light-mode', mode === 'light');
    });
    document.querySelector('.keyboard-title')?.classList.toggle('light-mode', mode === 'light');
    document.getElementById('settings-label').classList.toggle('light-mode', mode === 'light');
    document.getElementById('title').classList.toggle('light-mode', mode === 'light');
    
    // Apply light mode to timer mode label
    document.querySelectorAll('.timer-mode-label').forEach(el => {
      el.classList.toggle('light-mode', mode === 'light');
    });
    
    document.querySelectorAll('.lobby-form input, .lobby-form select').forEach(el => {
      el.classList.toggle('light-mode', mode === 'light');
    });
    document.querySelectorAll('.mode-button').forEach(el => {
      el.classList.toggle('light-mode', mode === 'light');
    });
    document.getElementById('hud').classList.toggle('light-mode', mode === 'light');
    document.getElementById('crossword').classList.toggle('light-mode', mode === 'light');
    document.querySelectorAll('.cell').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.black').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.clue-number').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.clue-list').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.clue-list h3').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.clue-list li').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    playerTurnDisplay.classList.toggle('light-mode', mode === 'light');
    highScoreDisplay.classList.toggle('light-mode', mode === 'light');
    document.querySelector('.leaderboard-title').classList.toggle('light-mode', mode === 'light');
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.leaderboard li').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.toggles label').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
    document.querySelectorAll('.keyboard-row button').forEach(el => el.classList.toggle('light-mode', mode === 'light'));
  }

  // --- Lobby Mode Selection Logic ---
  document.getElementById('start-single').addEventListener('click', function () {
    isTwoPlayerMode = false;
    player2Section.classList.add('hidden');
    startGame();
  });

  document.getElementById('start-two').addEventListener('click', function () {
    isTwoPlayerMode = !isTwoPlayerMode;
    if (isTwoPlayerMode) {
      player2Section.classList.remove('hidden');
      this.textContent = 'Back to Single';
      player2NameInput.focus();
    } else {
      player2Section.classList.add('hidden');
      this.textContent = '2-Player Mode';
    }
  });

  backToOneButton.addEventListener('click', function () {
    isTwoPlayerMode = false;
    player2Section.classList.add('hidden');
    document.getElementById('start-two').textContent = '2-Player Mode';
  });

  // --- Leaderboard Functions ---
  window.switchTab = function(tab) {
    currentLeaderboardTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => {
      if (t.textContent.toLowerCase() === tab) {
        t.classList.add('active');
      }
    });
    renderLeaderboard();
  };

  function renderLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    let arr = leaderboards[currentLeaderboardTab] || [];
    list.innerHTML = arr.length ? arr.slice(0, 5).map((e, i) => `<li>${i + 1}. ${e.name} — ${e.score}</li>`).join('') : '<li>No scores yet</li>';
  }

  function saveLeaderboard() {
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('crosswordLeaderboards', JSON.stringify(leaderboards));
    }
  }

  function addScore(name, score, difficulty) {
    let arr = leaderboards[difficulty] || [];
    arr.push({ name, score });
    arr = arr.sort((a, b) => b.score - a.score).slice(0, 5);
    leaderboards[difficulty] = arr;
    saveLeaderboard();
    renderLeaderboard();
  }
  renderLeaderboard();

  // --- Game Flow & State Management ---
  function startGame() {
    player1Name = player1NameInput.value.trim() || "Player 1";
    player2Name = player2NameInput.value.trim() || "Player 2";
    currentDifficulty = difficultySelect.value;
    lobbyDiv.classList.add('hidden');
    gameAreaDiv.style.display = 'block';
    setTheme(darkToggle.checked ? 'dark' : 'light');
    if (isTwoPlayerMode) {
      currentPlayer = 1;
      player1Score = 0;
      player2Score = 0;
      startPlayerTurn();
    } else {
      currentPuzzleScore = 0;
      currentPuzzleWordsCompleted = 0;
      startNewPuzzle();
    }
  }

  function startPlayerTurn() {
    playerTurnDisplay.textContent = `${currentPlayer === 1 ? player1Name : player2Name}'s Turn`;
    currentPuzzleScore = 0;
    currentPuzzleWordsCompleted = 0;
    freeHintUsed = false;
    startNewPuzzle();
  }

  function startNewPuzzle() {
    gameOver = false;
    newCrossword(currentDifficulty);
    currentPuzzleTotalWords = wordsMap.length;
    currentPuzzleWordsCompleted = 0;
    
    // FIXED: Improved timer with difficulty-based adjustments
    if (isTimedMode) {
      let baseTime = currentPuzzleTotalWords * 30;
      if (currentDifficulty === 'medium') baseTime += 60;
      else if (currentDifficulty === 'hard') baseTime += 90;
      timeLeft = baseTime;
      startTimer();
    } else {
      timeLeft = 0; // Unlimited time
    }
    
    updateHUD();
    
    if (isMobile()) {
      showVirtualKeyboard(true);
    }
  }

  function updateHUD() {
    if (typeof(Storage) !== "undefined" && localStorage) {
      currentHighScore = parseInt(localStorage.getItem('crosswordHighScore-' + currentDifficulty) || '0');
    } else {
      currentHighScore = 0;
    }
    highScoreDisplay.textContent = `High Score: ${currentHighScore}`;
    if (isTwoPlayerMode) {
      let timeDisplay = isTimedMode ? ` | Time: ${timeLeft}` : '';
      hudDisplay.textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}${timeDisplay}`;
    } else {
      let timeDisplay = isTimedMode ? ` | Time: ${timeLeft}` : '';
      hudDisplay.textContent = `Score: ${currentPuzzleScore}${timeDisplay} | Words: ${currentPuzzleWordsCompleted}/${currentPuzzleTotalWords}`;
    }
  }

  function startTimer() {
    if (!isTimedMode) return; // Don't start timer in unlimited mode
    
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (timeLeft > 0 && !gameOver) {
        timeLeft--;
        updateHUD();
      } else if (!gameOver) {
        clearInterval(timerInterval);
        gameOver = true;
        showFade(`⏰ Time's Up! Puzzle Failed!`);
        playLoseSound();
        setTimeout(() => {
          handlePuzzleEnd(false);
        }, 2000);
      }
    }, 1000);
  }

  function showFade(msg) {
    const fade = document.getElementById('fade-black');
    fade.innerHTML = msg;
    fade.classList.add('show');
    setTimeout(() => {
      fade.classList.remove('show');
    }, 1500);
  }

  function handlePuzzleEnd(completedSuccessfully) {
    clearInterval(timerInterval);
    gameOver = true;
    if (completedSuccessfully) {
      // FIXED: Only apply time bonus in timed mode
      let timeBonus = isTimedMode ? timeLeft * 10 : 0;
      currentPuzzleScore += timeBonus;
      if (isTimedMode) {
        showFade(`🎉 Puzzle Complete! +${timeBonus} bonus!`);
      } else {
        showFade(`🎉 Puzzle Complete!`);
      }
      playWinSound();
    } else {
      showFade(`💀 Puzzle Failed!`);
      playLoseSound();
    }
    if (isTwoPlayerMode) {
      if (currentPlayer === 1) {
        player1Score += currentPuzzleScore;
      } else {
        player2Score += currentPuzzleScore;
      }
      setTimeout(() => {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          startPlayerTurn();
        } else {
          let winnerText = player1Score > player2Score ? `${player1Name} Wins!` : player2Score > player1Score ? `${player2Name} Wins!` : "It's a Tie!";
          showFade(`Game Over! ${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}<br>${winnerText}`);
          if (player1Score !== player2Score) playWinSound();
          setTimeout(() => backToLobby(), 3000);
        }
      }, 2000);
    } else {
      if (currentPuzzleScore > currentHighScore) {
        currentHighScore = currentPuzzleScore;
        if (typeof(Storage) !== "undefined" && localStorage) {
          localStorage.setItem('crosswordHighScore-' + currentDifficulty, currentHighScore);
        }
      }
      addScore(player1Name, currentPuzzleScore, currentDifficulty);
      setTimeout(() => {
        if (completedSuccessfully) {
          currentPuzzleScore = 0;
          startNewPuzzle();
        } else {
          backToLobby();
        }
      }, 2000);
    }
  }

  window.backToLobby = function() {
    clearInterval(timerInterval);
    lobbyDiv.classList.remove('hidden');
    gameAreaDiv.style.display = 'none';
    renderLeaderboard();
    
    if (isMobile()) {
      showVirtualKeyboard(false);
    }
  };

  // --- FIXED: Crossword Game Logic with enforced word counts ---
  function settingsForDifficulty(diff) {
    switch (diff) {
      case "kids": return { min: 5, max: 7, size: 7 };
      case "easy": return { min: 6, max: 8, size: 8 };
      case "medium": return { min: 7, max: 9, size: 9 };
      case "hard": return { min: 8, max: 12, size: 11 };
      default: return { min: 7, max: 9, size: 9 };
    }
  }

  function newCrossword(difficulty = "medium") {
    const { min, max, size } = settingsForDifficulty(difficulty);
    gridSize = size;
    solutionGrid = Array.from({ length: gridSize }, () => Array(gridSize).fill(""));
    playerGrid = Array.from({ length: gridSize }, () => Array(gridSize).fill(""));
    wordsMap = [];
    clueCounter = 1;
    
    // FIXED: Enforce word count requirements
    let targetWordCount = Math.floor(Math.random() * (max - min + 1)) + min;
    let shuffledWords = [...wordBanks[difficulty]].sort(() => 0.5 - Math.random());
    let selectedWords = [];
    let attempts = 0;
    
    while (selectedWords.length < targetWordCount && attempts < 100) {
      selectedWords = [];
      solutionGrid = Array.from({ length: gridSize }, () => Array(gridSize).fill(""));
      wordsMap = [];
      clueCounter = 1;
      
      if (shuffledWords.length > 0) {
        placeWord(shuffledWords[0], Math.floor(gridSize / 2), Math.floor((gridSize - shuffledWords[0].length) / 2), "across");
        selectedWords.push(shuffledWords[0]);
      }
      
      for (let i = 1; i < shuffledWords.length && selectedWords.length < targetWordCount; i++) {
        let word = shuffledWords[i];
        let placed = placeWordSmart(word);
        if (placed) {
          selectedWords.push(word);
        }
      }
      attempts++;
    }
    
    currentPuzzleTotalWords = wordsMap.length;
    currentPuzzleWordsCompleted = 0;
    updateHUD();
    renderGrid();
    renderClues();
    
    if (wordsMap.length > 0) {
      selectWord(wordsMap[0]);
    }
  }

  function placeWord(word, row, col, dir) {
    let isNewNumber = !wordsMap.some(w => w.row === row && w.col === col);
    let clueNumber = isNewNumber ? clueCounter++ :
      wordsMap.find(w => w.row === row && w.col === col).clueNumber;
    for (let i = 0; i < word.length; i++) {
      let r = row + (dir === "down" ? i : 0);
      let c = col + (dir === "across" ? i : 0);
      solutionGrid[r][c] = solutionGrid[r][c] || word[i];
    }
    wordsMap.push({ word, row, col, dir, clueNumber, solved: false });
  }

  function placeWordSmart(word) {
    for (let base of wordsMap) {
      for (let i = 0; i < base.word.length; i++) {
        let letter = base.word[i];
        for (let j = 0; j < word.length; j++) {
          if (word[j] === letter) {
            let dir = base.dir === "across" ? "down" : "across";
            let row = base.row + (base.dir === "down" ? i : 0) - (dir === "down" ? j : 0);
            let col = base.col + (base.dir === "across" ? i : 0) - (dir === "across" ? j : 0);
            if (canPlace(word, row, col, dir, j)) {
              placeWord(word, row, col, dir);
              return true;
            }
          }
        }
      }
    }
    return false;
  }

  function canPlace(word, row, col, dir, offset) {
    if (dir === "across") {
      if (col < 0 || col + word.length > gridSize || row < 0 || row >= gridSize) return false;
      if (col > 0 && solutionGrid[row][col - 1] !== "") return false;
      if (col + word.length < gridSize && solutionGrid[row][col + word.length] !== "") return false;
    } else {
      if (row < 0 || row + word.length > gridSize || col < 0 || col >= gridSize) return false;
      if (row > 0 && solutionGrid[row - 1][col] !== "") return false;
      if (row + word.length < gridSize && solutionGrid[row + word.length][col] !== "") return false;
    }
    for (let i = 0; i < word.length; i++) {
      let r = row + (dir === "down" ? i : 0);
      let c = col + (dir === "across" ? i : 0);
      if (r < 0 || c < 0 || r >= gridSize || c >= gridSize) return false;
      let existing = solutionGrid[r][c];
      if (existing !== "" && existing !== word[i]) return false;
      if (existing === "" && (
        (dir === "across" && ((solutionGrid[r - 1]?.[c] || "") !== "" || (solutionGrid[r + 1]?.[c] || "") !== "")) ||
        (dir === "down" && ((solutionGrid[r][c - 1] || "") !== "" || (solutionGrid[r][c + 1] || "") !== ""))
      )) return false;
    }
    return true;
  }

  function renderGrid() {
    const cw = document.getElementById("crossword");
    cw.innerHTML = "";
    let minRow = gridSize, maxRow = -1, minCol = gridSize, maxCol = -1, hasContent = false;
    for (let r = 0; r < gridSize; r++) {
      for (let c = 0; c < gridSize; c++) {
        if (solutionGrid[r][c] !== "") {
          minRow = Math.min(minRow, r);
          maxRow = Math.max(maxRow, r);
          minCol = Math.min(minCol, c);
          maxCol = Math.max(maxCol, c);
          hasContent = true;
        }
      }
    }
    if (hasContent) {
      minRow = Math.max(0, minRow - 1);
      maxRow = Math.min(gridSize - 1, maxRow + 1);
      minCol = Math.max(0, minCol - 1);
      maxCol = Math.min(gridSize - 1, maxCol + 1);
      const actualWidth = maxCol - minCol + 1;
      const isMobile = window.innerWidth <= 600;
      const cellSize = isMobile ? '28px' : '32px';
      cw.style.gridTemplateColumns = `repeat(${actualWidth}, ${cellSize})`;
      cw.style.width = 'fit-content';
      cw.style.maxWidth = '100%';
      for (let r = minRow; r <= maxRow; r++) {
        for (let c = minCol; c <= maxCol; c++) {
          let div = document.createElement("div");
          div.className = "cell";
          div.dataset.row = r;
          div.dataset.col = c;
          const currentTheme = (typeof(Storage) !== "undefined" && localStorage) ? localStorage.getItem('theme') : 'dark';
          div.classList.toggle('light-mode', currentTheme === 'light');
          if (solutionGrid[r][c] === "") {
            div.classList.add("black");
            div.classList.toggle('light-mode', currentTheme === 'light');
          } else {
            let starter = wordsMap.find(w => w.row === r && w.col === c && w.clueNumber);
            if (starter) {
              let num = document.createElement("div");
              num.className = "clue-number";
              num.textContent = starter.clueNumber;
              num.classList.toggle('light-mode', currentTheme === 'light');
              div.appendChild(num);
            }
            if (playerGrid[r][c] !== "") {
              div.textContent = playerGrid[r][c].toUpperCase();
            }
            
            // FIXED: Add click handler for words in cells
            div.onclick = () => {
              let clickedWord = wordsMap.find(w =>
                r >= w.row && c >= w.col &&
                (w.dir === "across" ? r === w.row && c < w.col + w.word.length : c === w.col && r < w.row + w.word.length)
              );
              if (clickedWord) {
                selectWord(clickedWord);
                // Set activeCellIndex to the clicked cell position within the word
                if (clickedWord.dir === "across") {
                  activeCellIndex = c - clickedWord.col;
                } else {
                  activeCellIndex = r - clickedWord.row;
                }
                focusCell();
              }
            };
          }
          cw.appendChild(div);
        }
      }
    }
  }

  // --- FIXED: Enhanced Clue Bank with better clues that don't contain the word ---
  const clueBank = {
    easy: {
      animal: 'Living creature that moves and breathes',
      basket: 'Woven container for carrying items',
      button: 'Small fastener on clothing',
      dinner: 'Main evening meal of the day',
      eleven: 'Number that comes after ten',
      frozen: 'Turned to ice by cold temperature',
      garden: 'Outdoor space for growing plants',
      happy: 'Feeling joyful and pleased',
      island: 'Land completely surrounded by water',
      jacket: 'Outer garment worn for warmth',
      kitchen: 'Room where food is prepared',
      ladder: 'Climbing tool with steps or rungs',
      monkey: 'Primate that swings from trees',
      number: 'Mathematical symbol like 1, 2, 3',
      orange: 'Citrus fruit that is also a color',
      pencil: 'Writing instrument with graphite',
      rabbit: 'Small furry creature with long ears',
      school: 'Place where children learn',
      turtle: 'Slow reptile with a protective shell',
      uncle: 'Brother of your mother or father',
      valley: 'Low area of land between hills',
      window: 'Glass opening in a wall',
      yellow: 'Color of the sun and bananas',
      zebra: 'African equine with black and white stripes',
      answer: 'Response to a question',
      branch: 'Part of a tree that grows outward',
      cloudy: 'Sky covered with gray formations',
      donkey: 'Stubborn farm creature similar to a horse',
      enough: 'Sufficient amount, no more needed',
      flower: 'Colorful blooming part of a plant',
      ground: 'Surface of the earth you walk on',
      hungry: 'Feeling the need for food',
      inside: 'Within the interior of something',
      jungle: 'Dense tropical forest',
      kitten: 'Young feline, baby cat',
      letter: 'Written symbol or postal message',
      middle: 'Center point, not beginning or end',
      nephew: 'Son of your sibling',
      pickle: 'Cucumber preserved in brine',
      ribbon: 'Long decorative strip of fabric',
      simple: 'Easy to understand, not complex',
      things: 'Various objects or items',
      upward: 'Direction toward the sky',
      violet: 'Purple flower or that color',
      waffle: 'Breakfast food with square patterns',
      yogurt: 'Creamy dairy product',
      zipper: 'Fastener with interlocking teeth',
      always: 'At every time, constantly',
      banana: 'Long curved tropical fruit',
      candle: 'Wax stick that burns for light',
      doctor: 'Medical professional who treats illness',
      engine: 'Motor that powers vehicles',
      finger: 'One of five digits on your hand',
      handle: 'Part you grip to carry something',
      kindly: 'In a gentle, friendly manner',
      listen: 'Pay attention to sounds',
      market: 'Place where goods are sold',
      nature: 'The natural world outdoors',
      office: 'Workplace with desks and computers',
      person: 'Individual human being',
      quarter: 'One-fourth or 25-cent coin',
      reason: 'Explanation or cause',
      summer: 'Hottest season of the year',
      turkey: 'Large bird eaten at Thanksgiving',
      united: 'Joined together as one',
      violin: 'String instrument played with a bow',
      winter: 'Coldest season with snow',
      yearly: 'Happening once every twelve months',
      zombie: 'Fictional undead creature',
      apples: 'Red or green orchard fruit',
      bottle: 'Container for liquids',
      circle: 'Round shape with no corners',
      laptop: 'Portable computer',
      mouse: 'Small rodent or computer device',
      screen: 'Display surface for images',
      coffee: 'Hot caffeinated morning beverage',
      remote: 'Device for controlling electronics',
      charge: 'Restore power to a battery',
      energy: 'Power needed to do work',
      family: 'Related people living together',
      friend: 'Person you like and trust',
      memory: 'Ability to remember past events',
      silver: 'Precious white metal',
      golden: 'Made of or colored like gold',
      planet: 'Large celestial body orbiting a star',
      travel: 'Journey from one place to another',
      teacher: 'Person who educates students',
      student: 'Person who attends school',
      library: 'Building containing many books',
      eraser: 'Tool that removes pencil marks',
      marker: 'Thick pen for writing or coloring',
      supply: 'Provide what is needed',
      lesson: 'Period of instruction',
      future: 'Time that has not yet happened',
      dreams: 'Images and thoughts during sleep',
      clouds: 'White fluffy formations in the sky',
      light: 'Illumination that lets you see',
      spring: 'Season when flowers bloom',
      autumn: 'Season when leaves fall',
      forest: 'Large area covered with trees',
      desert: 'Dry sandy region with little water',
      river: 'Large flowing body of water',
      ocean: 'Vast body of salt water',
      giraffe: 'Tallest mammal with a long neck',
      panda: 'Black and white bear from China',
      whale: 'Largest marine mammal',
      sharks: 'Predatory fish with sharp teeth',
      eagles: 'Large birds of prey with keen eyesight',
      wolves: 'Wild canines that hunt in packs',
      foxes: 'Clever wild creatures with bushy tails',
      chicken: 'Farm bird that lays eggs',
      soccer: 'Sport played with feet and a round ball',
      dragon: 'Mythical fire-breathing creature',
      wizard: 'Magical person who casts spells',
      galaxy: 'Massive collection of stars',
      meteor: 'Space rock that burns in atmosphere',
      comet: 'Icy celestial object with a tail',
      corner: 'Point where two lines meet',
      falcon: 'Fast bird of prey',
      helmet: 'Protective headgear',
      insect: 'Small six-legged creature',
      jigsaw: 'Type of puzzle with pieces',
      recipe: 'Instructions for cooking food',
      spider: 'Eight-legged web-spinning creature',
      vacuum: 'Machine that sucks up dirt',
      walrus: 'Large marine mammal with tusks',
      yonder: 'Over there in the distance'
    },
    medium: {
      october: 'Tenth month, harvest time',
      quiver: 'Container for arrows or to shake',
      iguana: 'Large tropical lizard',
      notebook: 'Bound pages for writing notes',
      printer: 'Device that produces paper copies',
      holiday: 'Special day for celebration',
      thunder: 'Loud sound that follows lightning',
      mountain: 'Tall natural elevation of land',
      valleys: 'Low areas between elevated terrain',
      baseball: 'American sport with bats and bases',
      hockey: 'Sport played on ice with sticks',
      volcano: 'Mountain that can erupt molten rock',
      spaceship: 'Vehicle designed for space travel',
      science: 'Systematic study of natural phenomena',
      python: 'Programming language or large snake',
      variable: 'Symbol representing a changing value',
      function: 'Reusable block of code',
      object: 'Instance of a class in programming',
      array: 'Ordered collection of data elements',
      coding: 'Writing instructions for computers',
      server: 'Computer that provides network services',
      internet: 'Global network of connected computers',
      network: 'System of interconnected computers',
      amazon: 'Large online retailer or South American river',
      google: 'Popular search engine company',
      github: 'Platform for hosting code repositories',
      docker: 'Software for application containerization',
      oyster: 'Shellfish that may contain pearls',
      quartz: 'Common crystalline mineral',
      earwig: 'Insect with prominent pincers',
      kneads: 'Works dough with hands',
      quotas: 'Set limits or assigned targets',
      vulcan: 'Roman god of fire and metalworking',
      quiche: 'Savory custard pie with eggs',
      football: 'Sport with oval ball and goals',
      junkyard: 'Place where discarded items are stored',
      enormous: 'Extremely large in size',
      graceful: 'Moving with elegance and poise',
      horrible: 'Extremely unpleasant or frightening',
      jealousy: 'Feeling of envy toward others',
      kindness: 'Quality of being friendly and considerate',
      nonsense: 'Words or ideas without logical meaning',
      obtained: 'Acquired or got possession of',
      pleasant: 'Agreeable and enjoyable',
      quarters: 'Living spaces or one-fourth portions',
      recently: 'In the near past, not long ago',
      skeleton: 'Framework of bones in the body',
      triangle: 'Three-sided geometric shape',
      universe: 'All existing matter and space',
      villager: 'Person who lives in a small community',
      yourself: 'Referring to you personally',
      glorious: 'Magnificent and wonderful',
      haunting: 'Persistently memorable or ghostly',
      inventor: 'Person who creates new devices',
      jokester: 'Someone who enjoys telling jokes',
      keyboard: 'Input device with keys for typing',
      nautical: 'Related to ships and sailing',
      observed: 'Watched carefully or noticed',
      princess: 'Female member of royalty',
      quantity: 'Amount or number of something',
      whistled: 'Made a high-pitched musical sound',
      brilliant: 'Extremely bright or intelligent',
      decision: 'Choice made after consideration',
      judgment: 'Opinion formed after deliberation',
      research: 'Systematic investigation to discover facts',
      solution: 'Method of solving a problem',
      variety: 'Range of different things',
      accepted: 'Received willingly or agreed to',
      graphics: 'Visual images and designs',
      harmony: 'Pleasant combination of musical notes',
      machine: 'Device with moving parts for work',
      remarks: 'Comments or observations made',
      violent: 'Using physical force to cause harm',
      boundary: 'Line marking the limits of an area',
      document: 'Written or printed record',
      historic: 'Famous or important in history',
      journal: 'Daily record of events and thoughts',
      knuckle: 'Joint connecting finger sections',
      quilts: 'Warm bed coverings made of layers',
      xylose: 'Type of sugar found in wood',
      zipped: 'Fastened with a sliding closure',
      approx: 'Abbreviation meaning approximately',
      xenial: 'Relating to hospitality between host and guest',
      afraid: 'Feeling fear or anxiety',
      before: 'Earlier in time or in front of',
      chance: 'Possibility or opportunity',
      during: 'Throughout the course of',
      gentle: 'Mild and kind in manner',
      higher: 'At a greater elevation',
      indeed: 'In truth, certainly',
      locker: 'Storage compartment with a lock',
      modern: 'Contemporary, of the present time',
      native: 'Belonging naturally to a place',
      option: 'Choice available for selection',
      profit: 'Financial gain from business',
      quarry: 'Open pit for extracting stone',
      result: 'Consequence or outcome',
      stream: 'Small flowing body of water',
      tribal: 'Relating to a social group',
      unfold: 'Open up or develop gradually',
      victor: 'Person who wins a contest',
      xenons: 'Plural of xenon, a noble gas',
      zephyr: 'Gentle, mild breeze',
      action: 'Process of doing something',
      choice: 'Act of selecting between options',
      defeat: 'Win a victory over an opponent',
      entire: 'Whole, complete, all of it',
      global: 'Relating to the whole world',
      hushed: 'Made quiet or silenced',
      injury: 'Physical harm or damage',
      joyful: 'Feeling great happiness',
      lovely: 'Beautiful and attractive',
      medium: 'Middle state between extremes',
      narrow: 'Having a small width',
      openly: 'In a frank and honest way',
      pocket: 'Small pouch in clothing',
      quotes: 'Exact words spoken by someone',
      relate: 'Make a connection between things',
      sector: 'Distinct part of an economy',
      treaty: 'Formal agreement between nations',
      unable: 'Not having the ability to do',
      vector: 'Quantity with direction and magnitude',
      warmth: 'Quality of being warm',
      xylem: 'Plant tissue that transports water',
      yields: 'Produces or gives way to',
      accord: 'Agreement or harmony'
    },
    hard: {
      champion: 'Victor in a competition or contest',
      astronaut: 'Space traveler and explorer',
      javascript: 'Popular programming language for web development',
      terraform: 'Transform a planet to support life',
      lambda: 'Greek letter used in mathematics',
      elephant: 'Largest land mammal with a trunk',
      basketball: 'Sport played with hoops and dribbling',
      acknowledge: 'Accept or admit the existence of',
      architecture: 'Art and science of building design',
      biodiversity: 'Variety of life in ecosystems',
      championship: 'Competition to determine the best',
      demographic: 'Statistical data about populations',
      exponential: 'Mathematical growth that accelerates rapidly',
      fluctuation: 'Irregular rising and falling',
      gravitational: 'Relating to the force of gravity',
      hierarchical: 'Arranged in order of rank',
      implementation: 'Process of putting a plan into action',
      juxtaposition: 'Placing two things side by side',
      kaleidoscope: 'Tube with mirrors creating patterns',
      logarithmic: 'Mathematical scale of measurement',
      metamorphosis: 'Complete transformation process',
      neurological: 'Relating to the nervous system',
      optimization: 'Making something as effective as possible',
      philosophical: 'Relating to the study of wisdom',
      questionnaire: 'Set of questions for gathering data',
      revolutionary: 'Involving dramatic change',
      sophisticated: 'Complex and refined',
      technological: 'Relating to applied science',
      uncomfortable: 'Causing physical or mental unease',
      vulnerability: 'State of being exposed to harm',
      xylophone: 'Musical instrument with wooden bars',
      zenith: 'Highest point reached',
      absorption: 'Process of taking in completely',
      calibration: 'Adjustment for accurate measurement',
      democratization: 'Process of becoming more democratic',
      entrepreneurship: 'Activity of starting businesses',
      functionality: 'Quality of being useful',
      globalization: 'Process of international integration',
      hospitalization: 'Treatment in a medical facility',
      industrialization: 'Development of industries',
      justification: 'Action of showing something is right',
      liberalization: 'Removal of restrictions',
      maximization: 'Process of making as large as possible',
      normalization: 'Process of bringing to a standard',
      operationalization: 'Putting theory into practice',
      personalization: 'Tailoring to individual preferences',
      quantification: 'Expression in numerical terms',
      rationalization: 'Logical explanation for actions',
      standardization: 'Process of establishing standards',
      transformation: 'Complete change in form',
      urbanization: 'Growth of cities and towns',
      visualization: 'Formation of mental images',
      westernization: 'Adoption of Western culture',
      xerophyte: 'Plant adapted to dry conditions',
      yesteryear: 'Time in the recent past',
      zygote: 'Fertilized egg cell'
    },
    kids: {
      balloon: 'Colorful floating party decoration',
      puzzle: 'Game with pieces that fit together',
      rocket: 'Vehicle that flies to space',
      pirate: 'Sailor who searches for treasure',
      castle: 'Large stone building for royalty',
      jungle: 'Thick forest with many animals',
      monster: 'Scary imaginary creature',
      rainbow: 'Colorful arc in the sky after rain',
      penguin: 'Black and white bird from cold places',
      blanket: 'Soft cover to keep you warm',
      tractor: 'Big machine used on farms',
      diamond: 'Sparkling precious stone',
      pumpkin: 'Large orange vegetable',
      treasure: 'Hidden gold and jewels',
      dolphin: 'Smart sea animal that jumps',
      picture: 'Drawing or photo of something',
      pancake: 'Flat breakfast food with syrup',
      popcorn: 'Snack that puffs up when heated',
      unicorn: 'Magical horse with a horn',
      scooter: 'Two-wheeled vehicle you push',
      backpack: 'Bag you wear on your back',
      crystal: 'Clear shiny rock',
      fortune: 'Good luck or lots of money',
      journey: 'Long trip to faraway places',
      lantern: 'Light you can carry around',
      marbles: 'Small glass balls for games',
      octopus: 'Sea creature with eight arms',
      parasol: 'Small umbrella for shade',
      peacock: 'Bird with beautiful tail feathers',
      pretzel: 'Twisted salty snack',
      skating: 'Gliding on ice or wheels',
      snowman: 'Figure made from three snowballs',
      tornado: 'Spinning storm with strong winds',
      trouble: 'When something goes wrong',
      whistle: 'Makes a loud high sound',
      sandbox: 'Box filled with sand to play in',
      mailbox: 'Container for letters and packages',
      cabinet: 'Box with doors for storing things',
      mailman: 'Person who brings your mail'
    }
  };

  function getClue(word) {
    const diff = currentDifficulty;
    const clue = clueBank[diff]?.[word.toLowerCase()];
    
    if (clue) {
      return clue;
    }
    
    // Fallback for missing clues
    return `${word.length}-letter word`;
  }

  function renderClues() {
    const across = document.querySelector("#across-clues ul");
    const down = document.querySelector("#down-clues ul");
    across.innerHTML = "";
    down.innerHTML = "";
    wordsMap.forEach(w => {
      const clue = getClue(w.word);
      let li = document.createElement("li");
      li.innerHTML = `${w.clueNumber}. ${clue}`;
      li.onclick = () => selectWord(w);
      const currentTheme = (typeof(Storage) !== "undefined" && localStorage) ? localStorage.getItem('theme') : 'dark';
      li.classList.toggle('light-mode', currentTheme === 'light');
      
      // FIXED: Mark solved clues with visual indication
      if (w.solved) {
        li.classList.add('solved');
      }
      
      if (w.dir === "across") across.appendChild(li);
      else down.appendChild(li);
    });
    updateHUD();
  }

  function selectWord(word) {
    if (!word) return;
    activeWord = word;
    activeCellIndex = word.word.split('').findIndex((ch, i) => {
      let r = word.row + (word.dir === "down" ? i : 0);
      let c = word.col + (word.dir === "across" ? i : 0);
      return playerGrid[r][c] === "";
    });
    if (activeCellIndex === -1) activeCellIndex = 0;
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("highlight", "active"));
    for (let i = 0; i < word.word.length; i++) {
      let r = word.row + (word.dir === "down" ? i : 0);
      let c = word.col + (word.dir === "across" ? i : 0);
      let cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
      if (cell) cell.classList.add("highlight");
    }
    focusCell();
    focusMobileInput();
  }

  function focusCell() {
    if (!activeWord) return;
    let r = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
    let c = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("active"));
    let cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
    if (cell) cell.classList.add("active");
  }

  function focusMobileInput() {
    if (!isMobile()) {
      setTimeout(() => { mobileInput.focus(); }, 100);
    }
  }

  function handleLetterInput(letter) {
    if (!activeWord || gameOver) return;
    if (activeCellIndex >= activeWord.word.length) return;
    
    let row = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
    let col = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
    
    playerGrid[row][col] = letter.toLowerCase();
    renderGrid();
    checkWordCompletion(activeWord);
    
    if (activeCellIndex < activeWord.word.length - 1) {
      activeCellIndex++;
      focusCell();
    } else {
      let nextWordIndex = wordsMap.findIndex(w => !w.solved);
      if (nextWordIndex !== -1) {
        selectWord(wordsMap[nextWordIndex]);
      }
    }
  }

  function handleBackspace() {
    if (!activeWord || gameOver) return;
    
    let row = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
    let col = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
    
    if (playerGrid[row][col] === "" && activeCellIndex > 0) {
      activeCellIndex--;
      row = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
      col = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
    }
    
    playerGrid[row][col] = "";
    renderGrid();
    focusCell();
  }

  function handleMobileInput(char) {
    if (!activeWord || gameOver) return;
    if (char && char.match(/^[a-zA-Z]$/)) {
      handleLetterInput(char);
    }
  }

  function handleMobileBackspace() {
    if (!activeWord || gameOver) return;
    handleBackspace();
  }

  mobileInput.addEventListener('input', function(e) {
    e.preventDefault();
    const char = e.target.value.slice(-1);
    if (char) {
      handleMobileInput(char);
      e.target.value = '';
    }
  });

  mobileInput.addEventListener('keydown', function(e) {
    if (e.key === 'Backspace') {
      e.preventDefault();
      handleMobileBackspace();
    }
  });

  gameAreaDiv.addEventListener('touchstart', function(e) {
    if (activeWord && e.target.classList.contains('cell')) {
      e.preventDefault();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (gameOver || !activeWord) return;
    e.preventDefault();
    if (/^[a-zA-Z]$/.test(e.key)) {
      handleLetterInput(e.key);
    } else if (e.key === "Backspace") {
      handleBackspace();
    }
  });

  function checkWordCompletion(wordObj) {
    let currentWordAttempt = '';
    for (let i = 0; i < wordObj.word.length; i++) {
      let r = wordObj.row + (wordObj.dir === "down" ? i : 0);
      let c = wordObj.col + (wordObj.dir === "across" ? i : 0);
      currentWordAttempt += playerGrid[r][c] || '';
    }
    if (currentWordAttempt.toLowerCase() === wordObj.word.toLowerCase() && !wordObj.solved) {
      wordObj.solved = true;
      currentPuzzleWordsCompleted++;
      currentPuzzleScore += 10;
      updateHUD();
      renderClues(); // Update clues to show solved state
      showFade(`Word "${wordObj.word.toUpperCase()}" Solved!`);
      if (wordsMap.every(w => w.solved)) {
        handlePuzzleEnd(true);
      }
    }
  }

  window.checkPuzzle = function() {
    let allCorrect = true;
    for (const wordObj of wordsMap) {
      let currentWordAttempt = '';
      for (let i = 0; i < wordObj.word.length; i++) {
        let r = wordObj.row + (wordObj.dir === "down" ? i : 0);
        let c = wordObj.col + (wordObj.dir === "across" ? i : 0);
        currentWordAttempt += playerGrid[r][c] || '';
      }
      if (currentWordAttempt.toLowerCase() !== wordObj.word.toLowerCase()) {
        allCorrect = false;
        break;
      }
    }
    if (allCorrect) {
      gameOver = true;
      handlePuzzleEnd(true);
    } else {
      showFade("❌ Some answers are incorrect!");
    }
  };

  window.revealPuzzle = function() {
    if (gameOver) return;
    clearInterval(timerInterval);
    for (let r = 0; r < gridSize; r++) {
      for (let c = 0; c < gridSize; c++) {
        if (solutionGrid[r][c] !== "") {
          playerGrid[r][c] = solutionGrid[r][c];
        }
      }
    }
    renderGrid();
    showFade("📖 Puzzle Revealed!");
    setTimeout(() => {
      handlePuzzleEnd(false);
    }, 2000);
  };

  window.useHint = function() {
    if (gameOver) return;
    let unsolvedWords = wordsMap.filter(w => !w.solved);
    if (unsolvedWords.length === 0) {
      showFade("✅ All words are already solved!");
      return;
    }
    let wordToHint = unsolvedWords[Math.floor(Math.random() * unsolvedWords.length)];
    let hiddenLettersInWord = [];
    for (let i = 0; i < wordToHint.word.length; i++) {
      let r = wordToHint.row + (wordToHint.dir === "down" ? i : 0);
      let c = wordToHint.col + (wordToHint.dir === "across" ? i : 0);
      if (playerGrid[r][c] === "" || playerGrid[r][c].toLowerCase() !== wordToHint.word[i].toLowerCase()) {
        hiddenLettersInWord.push({ r, c, letter: wordToHint.word[i] });
      }
    }
    if (hiddenLettersInWord.length === 0) {
      wordToHint.solved = true;
      currentPuzzleWordsCompleted++;
      currentPuzzleScore += 10;
      updateHUD();
      window.useHint();
      return;
    }
    let hintCell = hiddenLettersInWord[Math.floor(Math.random() * hiddenLettersInWord.length)];
    playerGrid[hintCell.r][hintCell.c] = hintCell.letter;
    renderGrid();
    selectWord(wordToHint);
    let penalty = 0;
    if (!freeHintUsed) {
      freeHintUsed = true;
      showFade(`🆓 Free hint! "${hintCell.letter.toUpperCase()}" revealed`);
    } else {
      if (currentDifficulty === 'kids') penalty = 3;
      else if (currentDifficulty === 'easy') penalty = 5;
      else if (currentDifficulty === 'medium') penalty = 7;
      else penalty = 15;
      currentPuzzleScore -= penalty;
      if (currentPuzzleScore < 0) currentPuzzleScore = 0;
      updateHUD();
      showFade(`⚠️ Hint used! -${penalty} points. "${hintCell.letter.toUpperCase()}" revealed`);
    }
    checkWordCompletion(wordToHint);
  };

  // --- Virtual Keyboard Logic ---
  function isMobile() {
    return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) || window.innerWidth <= 768;
  }
  
  function showVirtualKeyboard(show) {
    if (virtualKeyboard) {
      if (show && isMobile()) {
        virtualKeyboard.classList.remove('hidden');
        virtualKeyboard.style.display = 'flex';
        const currentTheme = (typeof(Storage) !== "undefined" && localStorage) ? localStorage.getItem('theme') : 'dark';
        virtualKeyboard.classList.toggle('light-mode', currentTheme === 'light');
      } else {
        virtualKeyboard.classList.add('hidden');
        virtualKeyboard.style.display = 'none';
      }
    }
  }
  
  function initializeVirtualKeyboard() {
    if (!virtualKeyboard) return;
    
    const dockBtn = document.getElementById('dock-keyboard');
    const closeBtn = document.getElementById('close-keyboard');
    
    if (dockBtn) {
      dockBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        virtualKeyboard.classList.toggle('docked');
        const isDocked = virtualKeyboard.classList.contains('docked');
        dockBtn.textContent = isDocked ? '⇈' : '⇅';
        dockBtn.title = isDocked ? 'Undock' : 'Dock';
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showVirtualKeyboard(false);
      });
    }
    
    virtualKeyboard.querySelectorAll('button[data-key]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const key = btn.dataset.key;
        
        if (key === "Backspace") {
          handleBackspace();
        } else if (key && key.match(/^[A-Z]$/)) {
          handleLetterInput(key);
        }
        
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          btn.style.transform = '';
        }, 100);
      });
      
      btn.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
      
      btn.addEventListener('touchstart', (e) => {
        btn.style.transform = 'scale(0.95)';
      });
      
      btn.addEventListener('touchend', (e) => {
        setTimeout(() => {
          btn.style.transform = '';
        }, 100);
      });
    });
  }
  
  initializeVirtualKeyboard();

  // --- Sound Effects ---
  function playWinSound() {
    if (!soundToggle.checked) return;
    
    if (winSound.src && !winSound.src.endsWith(window.location.href)) {
      winSound.currentTime = 0;
      winSound.play().catch(() => {
        createBeepSound(800, 200);
      });
    } else {
      createBeepSound(800, 200);
    }
  }
  
  function playLoseSound() {
    if (!soundToggle.checked) return;
    
    if (loseSound.src && !loseSound.src.endsWith(window.location.href)) {
      loseSound.currentTime = 0;
      loseSound.play().catch(() => {
        createBeepSound(300, 500);
      });
    } else {
      createBeepSound(300, 500);
    }
  }

  function createBeepSound(frequency, duration) {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'square';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    } catch (e) {
      console.log('Could not create beep sound:', e);
    }
  }

  // Initial setup
  renderLeaderboard();
  const currentTheme = (typeof(Storage) !== "undefined" && localStorage) ? localStorage.getItem('theme') : 'dark';
  setTheme(currentTheme === 'dark' ? 'dark' : 'light');
  showVirtualKeyboard(false);
  
  console.log('🎮 NES Crossword Game Enhanced Edition initialized!');
});
</script>
</body>
</html>
