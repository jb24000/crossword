<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎮 NES Crossword 🎮</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
body {
  font-family: 'Press Start 2P', cursive;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  margin: 0;
  min-height: 100vh;
  transition: background 0.4s, color 0.4s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
}
.container {
  max-width: 480px;
  margin: 40px auto 0 auto;
  background: rgba(0,0,0,0.4);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  padding: 32px 18px 24px 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.title {
  font-size: 24px;
  color: #00ff88;
  margin-bottom: 10px;
  font-weight: bold;
  text-shadow: 2px 2px 0px #000;
  letter-spacing: 1px;
  text-align: center;
}
.toggles {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-bottom: 18px;
}
.switch { position:relative; display:inline-block; width:50px; height:24px; }
.switch input{display:none;}
.slider { position:absolute; top:0; left:0; right:0; bottom:0; background:#ccc; border-radius:34px; transition:.4s; }
.slider:before { content:""; position:absolute; width:18px; height:18px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.4s; }
input:checked+.slider { background:#00ff88; }
input:checked+.slider:before { transform:translateX(26px); }
.settings-label {
  font-size: 14px;
  color: #FFD700;
  margin-bottom: 10px;
  font-weight: bold;
  letter-spacing: 1px;
  text-align: center;
}
.lobby-form {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  align-items: center;
}
.lobby-form input, .lobby-form select {
  font-size: 16px;
  padding: 7px;
  border-radius: 8px;
  border: none;
  background: #f8f9fa;
  color: #222;
  width: 80%;
  max-width: 260px;
  margin: 0 auto;
  box-sizing: border-box;
}
.lobby-form label {
  font-size: 13px;
  color: #fff;
  margin-bottom: 2px;
  text-align: left;
  width: 80%;
  max-width: 260px;
}
.mode-buttons {
  display: flex;
  gap: 16px;
  margin-top: 10px;
  justify-content: center;
}
.mode-button {
  font-size: 16px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: #00ff88;
  color: #333;
  font-weight: bold;
  cursor: pointer;
  margin: 0 4px;
  transition: background 0.2s;
}
.mode-button:hover { background: #00cc6a; }
.hidden { display: none !important; }
#player2-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}
#player2-section label, #player2-section input {
  width: 80%;
  max-width: 260px;
}
#back-to-one {
  margin-top: 8px;
  background: #00ff88;
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  width: 80%;
  max-width: 260px;
}
#back-to-one:hover {
  background: #00cc6a;
}

.music-controls {
  display: flex;
  gap: 6px;
  margin-top: -6px;
  position: relative;
  left: 48%;
  transform: translateX(-40%);
}
.music-controls button {
  font-family: 'Press Start 2P', cursive;
  font-size: 12px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: #00ff88;
  color: #222;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}
.music-controls button:hover {
  background: #00cc6a;
}

#game-area {
  display: none;
  width: 100%;
  max-width: 600px;
  margin: 20px auto;
  padding: 20px;
  background: rgba(0,0,0,0.4);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  text-align: center;
}
#hud {
  margin: 10px;
  font-size: 12px;
  color: #FFD700;
  background: rgba(0,0,0,0.4);
  padding: 6px 12px;
  border-radius: 8px;
  border: 2px solid #FFD700;
  box-shadow: 2px 2px 0px #333;
  display: inline-block;
}
#crossword {
  display: grid;
  gap: 2px;
  background: #222;
  margin: 20px auto;
  padding: 10px;
  border: 4px solid #FFD700;
  border-radius: 12px;
  box-shadow: inset 4px 4px 0px #000, 4px 4px 0px #333;
  justify-content: center;
}
.cell {
  width: 30px; height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f8f9fa;
  color: #000;
  font-size: 14px;
  border: 1px solid #444;
  position: relative;
  cursor: pointer;
  font-weight: bold;
  box-shadow: inset -2px -2px 0px #bbb, inset 2px 2px 0px #fff;
}
.black {
  background: #111;
  border: 1px solid #000;
  box-shadow: inset -2px -2px 0px #000;
  cursor: default;
}
.clue-number {
  font-size: 8px;
  position: absolute;
  top: 1px;
  left: 2px;
  color: #444;
}
.highlight {
  background: #FFD700 !important;
  color: #222 !important;
}
.active {
  outline: 2px solid #00ff88;
}
.clues {
  display: grid;
  grid-template-columns: 1fr 1fr;
  width: 90%;
  max-width: 600px;
  margin: 20px auto;
  gap: 20px;
  font-size: 11px;
}
.clue-list {
  background: rgba(0,0,0,0.5);
  border: 2px solid #FFD700;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 3px 3px 0px #000;
}
.clue-list h3 {
  margin-bottom: 8px;
  font-size: 13px;
  color: #FFD700;
  border-bottom: 1px solid #FFD700;
  padding-bottom: 4px;
  text-align: center;
}
.clue-list ul {
  padding: 0;
  margin: 0;
  list-style: none;
}
.clue-list li {
  margin-bottom: 8px;
  line-height: 1.4;
  cursor: pointer;
  transition: color 0.2s;
}
.clue-list li:hover {
  color: #00ff88;
}
.game-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 10px;
}
.game-buttons button {
  padding: 10px 15px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background: #00ff88;
  color: #222;
  font-weight: bold;
  transition: background 0.2s;
}
.game-buttons button:hover {
  background: #00cc6a;
}
.fade-black {
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.95);
  color: #FFD700;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.7s;
}
.fade-black.show {
  opacity: 1;
  pointer-events: all;
}
.player-turn-display {
  font-size: 18px;
  color: #00ff88;
  margin-bottom: 10px;
  font-weight: bold;
}
.high-score-display {
  font-size: 14px;
  color: #FFD700;
  margin-top: 5px;
}
.leaderboard {
  text-align: center;
  margin-top: 18px;
}
.leaderboard-title {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #FFD700;
  border-bottom: 2px solid #FFD700;
  display: inline-block;
  padding-bottom: 4px;
  letter-spacing: 1px;
}
.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 10px;
  gap: 8px;
}
.tab {
  padding: 6px 12px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  color: #fff;
  font-weight: normal;
  border-radius: 4px 4px 0 0;
  background: none;
  transition: color 0.2s;
  font-size: 12px;
}
.tab.active {
  border-color: #FFD700;
  font-weight: bold;
  color: #FFD700;
  background: rgba(255,255,255,0.05);
}
.leaderboard ul { list-style: none; padding: 0; margin: 0; }
.leaderboard li {
  margin: 5px 0;
  font-size: 12px;
  color: #fff;
  font-weight: normal;
}

/* Light mode */
body.light-mode {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  color: #222;
}
.container.light-mode, #game-area.light-mode {
  background: rgba(255,255,255,0.7);
  color: #222;
}
.settings-label.light-mode { color: #222; }
.title.light-mode { color: #00b36b; text-shadow: 2px 2px 0px #fff; }

body.light-mode .lobby-form label {
  color: #222 !important;
}
.lobby-form input.light-mode, .lobby-form select.light-mode {
  background: #fff;
  color: #222;
  border: 1px solid #bbb;
}
.mode-button.light-mode { background: #00ff88; color: #222; }
.mode-button.light-mode:hover { background: #00cc6a; }

body.light-mode .toggles label {
  color: #222 !important;
}
body.light-mode .music-controls button {
  background: #00ff88;
  color: #222;
}
body.light-mode .music-controls button:hover {
  background: #00cc6a;
}

#hud.light-mode {
  color: #222;
  border-color: #222;
  background: rgba(255,255,255,0.8);
  box-shadow: 2px 2px 0px #bbb;
}
#crossword.light-mode {
  background: #eee;
  border-color: #222;
  box-shadow: inset 4px 4px 0px #bbb, 4px 4px 0px #aaa;
}
.cell.light-mode {
  background: #fff;
  color: #222;
  border-color: #bbb;
  box-shadow: inset -2px -2px 0px #ddd, inset 2px 2px 0px #eee;
}
.black.light-mode {
  background: #ccc;
  border-color: #aaa;
  box-shadow: inset -2px -2px 0px #aaa;
}
.clue-number.light-mode { color: #888; }
.highlight.light-mode {
  background: #FFD700 !important;
  color: #222 !important;
}
.active.light-mode {
  outline: 2px solid #00b36b;
}
.clue-list.light-mode {
  background: rgba(255,255,255,0.8);
  border-color: #222;
  box-shadow: 3px 3px 0px #bbb;
}
.clue-list h3.light-mode {
  color: #222;
  border-color: #222;
}
.clue-list li.light-mode { color: #222; }
.clue-list li.light-mode:hover { color: #00b36b; }
.player-turn-display.light-mode { color: #00b36b; }
.high-score-display.light-mode { color: #222; }

.leaderboard-title.light-mode {
  color: #222;
  border-color: #222;
}
.tab.light-mode { color: #222; }
.tab.active.light-mode {
  border-color: #FFD700;
  color: #FFD700;
  background: rgba(0,0,0,0.05);
}
.leaderboard li.light-mode {
  color: #222;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  body {
    padding: 10px;
    min-height: 100vh;
    box-sizing: border-box;
  }
  
  .container {
    margin: 0;
    max-width: 100%;
    width: 100%;
    padding: 20px 15px;
    box-sizing: border-box;
  }
  
  .title {
    font-size: 20px;
    margin-bottom: 15px;
  }
  
  .toggles {
    gap: 20px;
    margin-bottom: 15px;
  }
  
  .music-controls {
    left: 50%;
    transform: translateX(-50%);
    margin-top: 5px;
  }
  
  .music-controls button {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  #game-area {
    margin: 10px 0;
    padding: 15px 10px;
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
  }
  
  #crossword {
    margin: 15px auto;
    padding: 8px;
    max-width: 100%;
    overflow-x: auto;
  }
  
  .cell {
    width: 25px;
    height: 25px;
    font-size: 12px;
  }
  
  .clue-number {
    font-size: 7px;
    top: 1px;
    left: 1px;
  }
  
  .clues {
    grid-template-columns: 1fr;
    gap: 15px;
    width: 100%;
    margin: 15px 0;
  }
  
  .clue-list {
    padding: 8px;
    font-size: 10px;
  }
  
  .clue-list h3 {
    font-size: 12px;
    margin-bottom: 6px;
  }
  
  .clue-list li {
    margin-bottom: 6px;
    line-height: 1.3;
  }
  
  .game-buttons {
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
  }
  
  .game-buttons button {
    padding: 8px 12px;
    font-size: 12px;
    flex: 1;
    min-width: 120px;
  }
  
  .mode-buttons {
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }
  
  .mode-button {
    width: 100%;
    font-size: 14px;
    padding: 10px;
  }
  
  .lobby-form {
    width: 100%;
  }
  
  .lobby-form input, .lobby-form select {
    width: 100%;
    max-width: 100%;
    font-size: 14px;
  }
  
  .lobby-form label {
    width: 100%;
    max-width: 100%;
    font-size: 12px;
  }
  
  #player2-section label, #player2-section input, #back-to-one {
    width: 100%;
    max-width: 100%;
  }
  
  .tabs {
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .tab {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  .leaderboard-title {
    font-size: 12px;
  }
  
  .leaderboard li {
    font-size: 10px;
  }
  
  #hud {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  .player-turn-display {
    font-size: 16px;
  }
  
  .high-score-display {
    font-size: 12px;
  }
  
  .fade-black {
    font-size: 1.5rem;
    padding: 20px;
    text-align: center;
  }
}

.tabs {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
  flex-wrap: nowrap;
}

.tab {
  display: inline-block;
  white-space: nowrap;
}
  </style>
</head>
<body>
<div class="container" id="lobby">
  <div class="title" id="title">🎮 NES Crossword 🎮</div>
  
  <div class="toggles">
    <label>🌙 Dark
      <label class="switch">
        <input type="checkbox" id="darkToggle" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>🔊 Sound
      <label class="switch">
        <input type="checkbox" id="soundToggle">
        <span class="slider"></span>
      </label>
    </label>
  </div>

  <div class="music-controls">
    <button id="prev-track">⏮ Prev</button>
    <button id="next-track">Next ⏭</button>
  </div>

    <div class="settings-label" id="settings-label">SETTINGS</div>
    <form class="lobby-form" id="lobby-form" onsubmit="return false;">
      <label for="player1-name">Player 1 Name:</label>
      <input type="text" id="player1-name" placeholder="Player 1" required />
      <div id="player2-section" class="hidden">
        <label for="player2-name">Player 2 Name:</label>
        <input type="text" id="player2-name" placeholder="Player 2" />
        <button type="button" id="back-to-one">Back to Player 1</button>
      </div>
      <label for="difficulty">Difficulty:</label>
      <select id="difficulty">
        <option value="kids">Kids</option>
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
      </select>
      <div class="mode-buttons">
        <button class="mode-button" id="start-single">Start Game</button>
        <button class="mode-button" id="start-two">2-Player Mode</button>
      </div>
    </form>

   <div id="music-player" style="width:0;height:0;overflow:hidden;">
  <iframe
    id="yt-music"
    width="0"
    height="0"
    frameborder="0"
    allow="autoplay; encrypted-media"
    src="https://www.youtube.com/embed/BlBbwNgeOqQ?autoplay=1&loop=1&playlist=BlBbwNgeOqQ&controls=0&muted=1&enablejsapi=1"
  ></iframe>
   </div>
    <div class="leaderboard">
      <div class="leaderboard-title">Leaderboard</div>
      <div class="tabs">
        <div class="tab" onclick="switchTab('kids')">Kids</div>
        <div class="tab" onclick="switchTab('easy')">Easy</div>
        <div class="tab active" onclick="switchTab('medium')">Medium</div>
        <div class="tab" onclick="switchTab('hard')">Hard</div>
      </div>
      <ul id="leaderboard-list"></ul>
    </div>
  </div>

  <div id="game-area">
    <div class="player-turn-display" id="player-turn-display"></div>
    <div id="hud">Score: 0 | Time: 0 | Words: 0</div>
    <div class="high-score-display" id="high-score-display">High Score: 0</div>
    <div id="crossword"></div>
    <div class="clues">
      <div class="clue-list" id="across-clues">
        <h3>Across</h3>
        <ul></ul>
      </div>
      <div class="clue-list" id="down-clues">
        <h3>Down</h3>
        <ul></ul>
      </div>
    </div>
    <div class="game-buttons">
      <button onclick="useHint()">Get Hint</button>
      <button onclick="checkPuzzle()">Check Puzzle</button>
      <button onclick="revealPuzzle()">Reveal Puzzle</button>
      <button onclick="backToLobby()">🏠 Back to Lobby</button>
    </div>
  </div>

  <div class="fade-black" id="fade-black"></div>

  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="lose-sound" src="lose.mp3" preload="auto"></audio>

  <script>
    const wordBanks = {
      easy: [
        'animal', 'basket', 'button', 'castle', 'dinner', 'eleven', 'frozen', 'garden', 'happy', 'island',
        'jacket', 'kitchen', 'ladder', 'monkey', 'number', 'orange', 'pencil', 'rabbit', 'school', 'turtle',
        'uncle', 'valley', 'window', 'yellow', 'zebra', 'answer', 'branch', 'cloudy', 'donkey', 'enough',
        'flower', 'ground', 'hungry', 'inside', 'jungle', 'kitten', 'letter', 'middle', 'nephew', 'pickle',
        'ribbon', 'simple', 'things', 'upward', 'violet', 'waffle', 'yogurt', 'zipper', 'always', 'banana',
        'candle', 'doctor', 'engine', 'finger', 'handle', 'kindly', 'listen', 'market', 'nature', 'office',
        'person', 'quarter', 'reason', 'summer', 'turkey', 'united', 'violin', 'winter', 'yearly', 'zombie'
      ],
      medium: [
        'queen', 'october', 'quiver', 'iguana', 'notebook', 'printer', 'holiday', 'rainbow', 'thunder', 'mountain',
        'valleys', 'dolphin', 'rabbits', 'baseball', 'hockey', 'volcano', 'treasure', 'spaceship', 'science', 'python',
        'variable', 'function', 'object', 'array', 'coding', 'server', 'internet', 'network', 'amazon', 'google',
        'github', 'docker', 'oyster', 'quartz', 'earwig', 'kneads', 'quotas', 'vulcan', 'quiche', 'football',
        'junkyard', 'enormous', 'graceful', 'horrible', 'jealousy', 'kindness', 'nonsense', 'obtained', 'pleasant',
        'quarters', 'recently', 'skeleton', 'triangle', 'universe', 'villager', 'yourself', 'glorious', 'haunting'
      ],
      hard: [
        'champion', 'astronaut', 'javascript', 'terraform', 'lambda', 'elephant', 'basketball', 'spaceship',
        'brilliant', 'decision', 'research', 'solution', 'universe', 'variety', 'accepted', 'graphics',
        'harmony', 'machine', 'natural', 'perfect', 'quality', 'remarks', 'shelter', 'tonight', 'violent',
        'whisper', 'boundary', 'document', 'friendly', 'historic', 'journal', 'machine', 'natural', 'perfect'
      ],
      kids: [
        'balloon', 'puzzle', 'rocket', 'pirate', 'castle', 'jungle', 'monster', 'rainbow', 'penguin', 'blanket',
        'tractor', 'diamond', 'pumpkin', 'treasure', 'dolphin', 'picture', 'pancake', 'popcorn', 'unicorn', 'scooter',
        'backpack', 'crystal', 'fortune', 'journey', 'lantern', 'marbles', 'octopus', 'parasol', 'peacock', 'pretzel',
        'skating', 'snowman', 'tornado', 'trouble', 'whistle', 'sandbox', 'mailbox', 'cabinet', 'mailman', 'acorn'
      ]
    };

    let player1Name = '';
    let player2Name = '';
    let currentDifficulty = 'medium';
    let isTwoPlayerMode = false;
    let currentPlayer = 1;
    let player1Score = 0;
    let player2Score = 0;
    let currentPuzzleScore = 0;
    let currentPuzzleWordsCompleted = 0;
    let currentPuzzleTotalWords = 0;
    let timeLeft = 0;
    let timerInterval;
    let freeHintUsed = false;
    let gameOver = false;
    let currentHighScore = 0;

    let leaderboards = (() => {
      try {
        return JSON.parse(localStorage.getItem('crosswordLeaderboards')) || { kids: [], easy: [], medium: [], hard: [] };
      } catch (e) {
        return { kids: [], easy: [], medium: [], hard: [] };
      }
    })();
    
    ['kids', 'easy', 'medium', 'hard'].forEach(d => {
      if (!leaderboards[d]) leaderboards[d] = [];
    });
    let currentLeaderboardTab = 'medium';

    const lobbyDiv = document.getElementById('lobby');
    const gameAreaDiv = document.getElementById('game-area');
    const player1NameInput = document.getElementById('player1-name');
    const player2NameInput = document.getElementById('player2-name');
    const difficultySelect = document.getElementById('difficulty');
    const player2Section = document.getElementById('player2-section');
    const backToOneButton = document.getElementById('back-to-one');
    const hudDisplay = document.getElementById('hud');
    const highScoreDisplay = document.getElementById('high-score-display');
    const playerTurnDisplay = document.getElementById('player-turn-display');
    const darkToggle = document.getElementById('darkToggle');
    const soundToggle = document.getElementById('soundToggle');
    const ytMusicIframe = document.getElementById('yt-music');
    const winSound = document.getElementById('win-sound');
    const loseSound = document.getElementById('lose-sound');

    let gridSize, solutionGrid, playerGrid, words, wordsMap = [], clueCounter = 1;
    let activeWord = null, activeCellIndex = 0;

    let defaultTheme = 'dark';
    let defaultSound = 'off';
    
    try {
      defaultTheme = localStorage.getItem('theme') || 'dark';
      defaultSound = localStorage.getItem('sound') || 'off';
    } catch (e) {
      // Fallback for environments where localStorage isn't available
    }

    darkToggle.checked = defaultTheme === 'dark';
    soundToggle.checked = defaultSound === 'on';
    setTheme(darkToggle.checked ? 'dark' : 'light');

    darkToggle.addEventListener('change', function () {
      setTheme(this.checked ? 'dark' : 'light');
      try {
        localStorage.setItem('theme', this.checked ? 'dark' : 'light');
      } catch (e) {
        // Ignore localStorage errors on mobile
      }
    });

    function setTheme(mode) {
      const isLight = mode === 'light';
      
      document.body.classList.toggle('light-mode', isLight);
      lobbyDiv.classList.toggle('light-mode', isLight);
      gameAreaDiv.classList.toggle('light-mode', isLight);
      
      const themedElements = [
        '#settings-label', '#title', '#hud', '#crossword',
        '.player-turn-display', '.high-score-display', '.leaderboard-title'
      ];
      
      themedElements.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
          element.classList.toggle('light-mode', isLight);
        }
      });
      
      document.querySelectorAll('.lobby-form input, .lobby-form select').forEach(el => {
        el.classList.toggle('light-mode', isLight);
      });
      
      document.querySelectorAll('.lobby-form label').forEach(el => {
        el.classList.toggle('light-mode', isLight);
      });
      
      document.querySelectorAll('.toggles label').forEach(el => {
        el.classList.toggle('light-mode', isLight);
      });
      
      document.querySelectorAll('.music-controls button').forEach(el => {
        el.classList.toggle('light-mode', isLight);
      });
      
      document.querySelectorAll('.mode-button').forEach(el => {
        el.classList.toggle('light-mode', isLight);
      });
      
      document.querySelectorAll('.cell').forEach(el => el.classList.toggle('light-mode', isLight));
      document.querySelectorAll('.black').forEach(el => el.classList.toggle('light-mode', isLight));
      document.querySelectorAll('.clue-number').forEach(el => el.classList.toggle('light-mode', isLight));
      
      document.querySelectorAll('.clue-list').forEach(el => el.classList.toggle('light-mode', isLight));
      document.querySelectorAll('.clue-list h3').forEach(el => el.classList.toggle('light-mode', isLight));
      document.querySelectorAll('.clue-list li').forEach(el => el.classList.toggle('light-mode', isLight));
      
      document.querySelectorAll('.tab').forEach(el => el.classList.toggle('light-mode', isLight));
      document.querySelectorAll('.leaderboard li').forEach(el => el.classList.toggle('light-mode', isLight));
    }

    soundToggle.addEventListener('change', function () {
      try {
        localStorage.setItem('sound', this.checked ? 'on' : 'off');
      } catch (e) {
        // Ignore localStorage errors
      }
      handleMusic(this.checked);
    });

    let musicStarted = false;

    const playlist = [
      "fs0BCIUQ7Ws", "VpqoE7ft284", "TfEZaH_BBLY", "V6SJzeegnck", 
      "pzkAKQJv19A", "CIWo9e1Qzos", "WvzVYC507gU"
    ];
    let currentTrackIndex = 0;

    function loadTrack(index, shouldPlay = true) {
      currentTrackIndex = (index + playlist.length) % playlist.length;
      const videoId = playlist[currentTrackIndex];
      ytMusicIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=${shouldPlay ? 1 : 0}&loop=0&controls=0&muted=0&enablejsapi=1`;
      musicStarted = true;
    }

    function handleMusic(on) {
      if (on) {
        if (!musicStarted) {
          loadTrack(currentTrackIndex);
        } else {
          try {
            ytMusicIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
          } catch (e) {
            console.log('Music play failed:', e);
          }
        }
      } else {
        try {
          ytMusicIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        } catch (e) {
          console.log('Music pause failed:', e);
        }
      }
    }

    document.getElementById("next-track").addEventListener("click", () => {
      loadTrack(currentTrackIndex + 1, soundToggle.checked);
    });
    document.getElementById("prev-track").addEventListener("click", () => {
      loadTrack(currentTrackIndex - 1, soundToggle.checked);
    });

    window.addEventListener("message", function (event) {
      if (event.data && typeof event.data === "string" && event.data.includes('"infoDelivery"')) {
        try {
          const data = JSON.parse(event.data);
          if (data.event === "infoDelivery" && data.info && data.info.playerState === 0) {
            loadTrack(currentTrackIndex + 1, soundToggle.checked);
          }
        } catch (e) {
          console.log("Player message parse error:", e);
        }
      }
    });

    function playWinSound() {
      if (soundToggle.checked) {
        winSound.currentTime = 0;
        winSound.play().catch(e => console.log('Win sound failed:', e));
      }
    }
    function playLoseSound() {
      if (soundToggle.checked) {
        loseSound.currentTime = 0;
        loseSound.play().catch(e => console.log('Lose sound failed:', e));
      }
    }

    document.getElementById('start-single').addEventListener('click', function () {
      isTwoPlayerMode = false;
      player2Section.classList.add('hidden');
      startGame();
    });

    document.getElementById('start-two').addEventListener('click', function () {
      isTwoPlayerMode = !isTwoPlayerMode;
      if (isTwoPlayerMode) {
        player2Section.classList.remove('hidden');
        this.textContent = 'Back to Player 1';
        player2NameInput.focus();
      } else {
        player2Section.classList.add('hidden');
        this.textContent = '2-Player Mode';
      }
    });

    backToOneButton.addEventListener('click', function () {
      isTwoPlayerMode = false;
      player2Section.classList.add('hidden');
      document.getElementById('start-two').textContent = '2-Player Mode';
    });

    function switchTab(tab) {
      currentLeaderboardTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => {
        if (t.textContent.toLowerCase() === tab) {
          t.classList.add('active');
        }
      });
      renderLeaderboard();
    }

    function renderLeaderboard() {
      const list = document.getElementById('leaderboard-list');
      let arr = leaderboards[currentLeaderboardTab] || [];
      list.innerHTML = arr.length ? arr.slice(0, 5).map((e, i) => `<li>${i + 1}. ${e.name} — ${e.score}</li>`).join('') : '<li>No scores yet</li>';
    }

    function saveLeaderboard() {
      try {
        localStorage.setItem('crosswordLeaderboards', JSON.stringify(leaderboards));
      } catch (e) {
        // Ignore localStorage errors on mobile
      }
    }

    function addScore(name, score, difficulty) {
      let arr = leaderboards[difficulty] || [];
      arr.push({ name, score });
      arr = arr.sort((a, b) => b.score - a.score).slice(0, 5);
      leaderboards[difficulty] = arr;
      saveLeaderboard();
      renderLeaderboard();
    }
    renderLeaderboard();

    function startGame() {
      player1Name = player1NameInput.value.trim() || "Player 1";
      player2Name = player2NameInput.value.trim() || "Player 2";
      currentDifficulty = difficultySelect.value;

      lobbyDiv.classList.add('hidden');
      gameAreaDiv.style.display = 'block';
      setTheme(darkToggle.checked ? 'dark' : 'light');

      if (isTwoPlayerMode) {
        currentPlayer = 1;
        player1Score = 0;
        player2Score = 0;
        startPlayerTurn();
      } else {
        currentPuzzleScore = 0;
        currentPuzzleWordsCompleted = 0;
        startNewPuzzle();
      }
    }

    function startPlayerTurn() {
      playerTurnDisplay.textContent = `${currentPlayer === 1 ? player1Name : player2Name}'s Turn`;
      currentPuzzleScore = 0;
      currentPuzzleWordsCompleted = 0;
      freeHintUsed = false;
      startNewPuzzle();
    }

    function startNewPuzzle() {
      gameOver = false;
      newCrossword(currentDifficulty);
      currentPuzzleTotalWords = wordsMap.length;
      currentPuzzleWordsCompleted = 0;
      timeLeft = currentPuzzleTotalWords * 30;
      updateHUD();
      startTimer();
    }

    function updateHUD() {
      try {
        currentHighScore = parseInt(localStorage.getItem('crosswordHighScore-' + currentDifficulty) || '0');
      } catch (e) {
        currentHighScore = 0;
      }
      highScoreDisplay.textContent = `High Score: ${currentHighScore}`;

      if (isTwoPlayerMode) {
        hudDisplay.textContent = `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score} | Time: ${timeLeft}`;
      } else {
        hudDisplay.textContent = `Score: ${currentPuzzleScore} | Time: ${timeLeft} | Words: ${currentPuzzleWordsCompleted}/${currentPuzzleTotalWords}`;
      }
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (timeLeft > 0 && !gameOver) {
          timeLeft--;
          updateHUD();
        } else if (!gameOver) {
          clearInterval(timerInterval);
          gameOver = true;
          showFade(`⏰ Time's Up! Puzzle Failed!`);
          playLoseSound();
          setTimeout(() => {
            handlePuzzleEnd(false);
          }, 2000);
        }
      }, 1000);
    }

    function showFade(msg) {
      const fade = document.getElementById('fade-black');
      fade.innerHTML = msg;
      fade.classList.add('show');
      setTimeout(() => {
        fade.classList.remove('show');
      }, 1500);
    }

    function handlePuzzleEnd(completedSuccessfully) {
      clearInterval(timerInterval);
      gameOver = true;

      if (completedSuccessfully) {
        let timeBonus = timeLeft * 10;
        currentPuzzleScore += timeBonus;
        showFade(`🎉 Puzzle Complete! +${timeBonus} bonus!`);
        playWinSound();
      } else {
        showFade(`💀 Puzzle Failed!`);
        playLoseSound();
      }

      if (isTwoPlayerMode) {
        if (currentPlayer === 1) {
          player1Score += currentPuzzleScore;
        } else {
          player2Score += currentPuzzleScore;
        }
        setTimeout(() => {
          if (currentPlayer === 1) {
            currentPlayer = 2;
            startPlayerTurn();
          } else {
            let winnerText = player1Score > player2Score ? `${player1Name} Wins!` : player2Score > player1Score ? `${player2Name} Wins!` : "It's a Tie!";
            showFade(`Game Over! ${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}<br>${winnerText}`);
            if (player1Score !== player2Score) playWinSound();
            setTimeout(() => backToLobby(), 3000);
          }
        }, 2000);
      } else {
        if (currentPuzzleScore > currentHighScore) {
          currentHighScore = currentPuzzleScore;
          try {
            localStorage.setItem('crosswordHighScore-' + currentDifficulty, currentHighScore);
          } catch (e) {
            // Ignore localStorage errors
          }
        }
        addScore(player1Name, currentPuzzleScore, currentDifficulty);
        setTimeout(() => {
          if (completedSuccessfully) {
            currentPuzzleScore = 0;
            startNewPuzzle();
          } else {
            backToLobby();
          }
        }, 2000);
      }
    }

    function backToLobby() {
      clearInterval(timerInterval);
      lobbyDiv.classList.remove('hidden');
      gameAreaDiv.style.display = 'none';
      renderLeaderboard();
    }

    function settingsForDifficulty(diff) {
      switch (diff) {
        case "kids": return { min: 10, max: 15, size: 8 };
        case "easy": return { min: 15, max: 20, size: 10 };
        case "medium": return { min: 20, max: 30, size: 12 };
        case "hard": return { min: 30, max: 40, size: 15 };
        default: return { min: 20, max: 30, size: 12 };
      }
    }

    function newCrossword(difficulty = "medium") {
      const { min, max, size } = settingsForDifficulty(difficulty);
      gridSize = size;
      solutionGrid = Array.from({ length: gridSize }, () => Array(gridSize).fill(""));
      playerGrid = Array.from({ length: gridSize }, () => Array(gridSize).fill(""));
      wordsMap = [];
      clueCounter = 1;

      let count = Math.floor(Math.random() * (max - min + 1)) + min;
      let shuffledWords = wordBanks[difficulty].sort(() => 0.5 - Math.random());
      let selectedWords = shuffledWords.slice(0, count);

      if (selectedWords.length > 0) {
        placeWord(selectedWords[0], Math.floor(gridSize / 2), Math.floor((gridSize - selectedWords[0].length) / 2), "across");
      }

      for (let i = 1; i < selectedWords.length; i++) {
        let word = selectedWords[i];
        let placed = placeWordSmart(word);
        if (!placed) {
          console.warn(`Could not place word: ${word}`);
        }
      }

      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
          if (solutionGrid[r][c] === "") {
            solutionGrid[r][c] = "";
          }
        }
      }

      currentPuzzleTotalWords = wordsMap.length;
      currentPuzzleWordsCompleted = 0;
      updateHUD();

      renderGrid();
      renderClues();
    }

    function placeWord(word, row, col, dir) {
      let isNewNumber = !wordsMap.some(w => w.row === row && w.col === col);
      let clueNumber = isNewNumber ? clueCounter++ :
        wordsMap.find(w => w.row === row && w.col === col).clueNumber;

      for (let i = 0; i < word.length; i++) {
        let r = row + (dir === "down" ? i : 0);
        let c = col + (dir === "across" ? i : 0);
        solutionGrid[r][c] = solutionGrid[r][c] || word[i];
      }
      wordsMap.push({ word, row, col, dir, clueNumber, solved: false });
    }

    function placeWordSmart(word) {
      for (let base of wordsMap) {
        for (let i = 0; i < base.word.length; i++) {
          let letter = base.word[i];
          for (let j = 0; j < word.length; j++) {
            if (word[j] === letter) {
              let dir = base.dir === "across" ? "down" : "across";
              let row = base.row + (base.dir === "down" ? i : 0) - (dir === "down" ? j : 0);
              let col = base.col + (base.dir === "across" ? i : 0) - (dir === "across" ? j : 0);
              if (canPlace(word, row, col, dir, j)) {
                placeWord(word, row, col, dir);
                return true;
              }
            }
          }
        }
      }
      return false;
    }

    function canPlace(word, row, col, dir, offset) {
      if (dir === "across") {
        if (col < 0 || col + word.length > gridSize || row < 0 || row >= gridSize) return false;
        if (col > 0 && solutionGrid[row][col - 1] !== "") return false;
        if (col + word.length < gridSize && solutionGrid[row][col + word.length] !== "") return false;
      } else {
        if (row < 0 || row + word.length > gridSize || col < 0 || col >= gridSize) return false;
        if (row > 0 && solutionGrid[row - 1][col] !== "") return false;
        if (row + word.length < gridSize && solutionGrid[row + word.length][col] !== "") return false;
      }
      for (let i = 0; i < word.length; i++) {
        let r = row + (dir === "down" ? i : 0);
        let c = col + (dir === "across" ? i : 0);
        if (r < 0 || c < 0 || r >= gridSize || c >= gridSize) return false;
        let existing = solutionGrid[r][c];
        if (existing !== "" && existing !== word[i]) return false;
        if (existing === "" && (
          (dir === "across" && ((solutionGrid[r - 1]?.[c] || "") !== "" || (solutionGrid[r + 1]?.[c] || "") !== "")) ||
          (dir === "down" && ((solutionGrid[r][c - 1] || "") !== "" || (solutionGrid[r][c + 1] || "") !== ""))
        )) return false;
      }
      return true;
    }

    function renderGrid() {
      const cw = document.getElementById("crossword");
      cw.innerHTML = "";
      cw.style.gridTemplateColumns = `repeat(${gridSize}, 30px)`;
      
      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
          let div = document.createElement("div");
          div.className = "cell";
          div.dataset.row = r;
          div.dataset.col = c;
          
          const isLight = !darkToggle.checked;
          div.classList.toggle('light-mode', isLight);

          if (solutionGrid[r][c] === "") {
            div.classList.add("black");
            div.classList.toggle('light-mode', isLight);
          } else {
            let starter = wordsMap.find(w => w.row === r && w.col === c && w.clueNumber);
            if (starter) {
              let num = document.createElement("div");
              num.className = "clue-number";
              num.textContent = starter.clueNumber;
              num.classList.toggle('light-mode', isLight);
              div.appendChild(num);
            }
            if (playerGrid[r][c] !== "") {
              div.textContent = playerGrid[r][c].toUpperCase();
            }
            div.onclick = () => selectWord(wordsMap.find(w =>
              r >= w.row && c >= w.col &&
              (w.dir === "across" ? r === w.row && c < w.col + w.word.length : c === w.col && r < w.row + w.word.length)
            ));
          }
          cw.appendChild(div);
        }
      }
    }

    async function getClue(word) {
      try {
        let res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        let data = await res.json();
        let def = data[0]?.meanings?.[0]?.definitions?.[0]?.definition;
        if (def) return def;
      } catch (e) { }
      return `${word.length}-letter word starting with ${word[0].toUpperCase()}`;
    }

    function renderClues() {
      const across = document.querySelector("#across-clues ul");
      const down = document.querySelector("#down-clues ul");
      across.innerHTML = "";
      down.innerHTML = "";
      hudDisplay.textContent = "Fetching clues...";

      Promise.all(wordsMap.map(w => getClue(w.word).then(clue => ({ ...w, clue }))))
        .then(results => {
          const isLight = !darkToggle.checked;
          results.forEach(w => {
            let li = document.createElement("li");
            li.innerHTML = `${w.clueNumber}. ${w.clue}`;
            li.onclick = () => selectWord(w);
            li.classList.toggle('light-mode', isLight);
            if (w.dir === "across") across.appendChild(li);
            else down.appendChild(li);
          });
          updateHUD();
        });
    }

    function selectWord(word) {
      if (!word) return;
      activeWord = word;
      activeCellIndex = word.word.split('').findIndex((ch, i) => {
        let r = word.row + (word.dir === "down" ? i : 0);
        let c = word.col + (word.dir === "across" ? i : 0);
        return playerGrid[r][c] === "";
      });
      if (activeCellIndex === -1) activeCellIndex = 0;

      document.querySelectorAll(".cell").forEach(c => c.classList.remove("highlight", "active"));
      for (let i = 0; i < word.word.length; i++) {
        let r = word.row + (word.dir === "down" ? i : 0);
        let c = word.col + (word.dir === "across" ? i : 0);
        let cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if (cell) cell.classList.add("highlight");
      }
      focusCell();
    }

    function focusCell() {
      if (!activeWord) return;
      let r = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
      let c = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
      document.querySelectorAll(".cell").forEach(c => c.classList.remove("active"));
      let cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
      if (cell) cell.classList.add("active");
    }

    document.addEventListener("keydown", e => {
      if (!activeWord || gameOver) return;
      if (e.key.match(/^[a-zA-Z]$/)) {
        let r = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
        let c = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
        playerGrid[r][c] = e.key.toLowerCase();
        renderGrid();
        checkWordCompletion(activeWord);
        if (activeCellIndex < activeWord.word.length - 1) {
          activeCellIndex++;
          focusCell();
        } else {
          let nextWordIndex = wordsMap.findIndex(w => !w.solved);
          if (nextWordIndex !== -1) {
            selectWord(wordsMap[nextWordIndex]);
          } else {
            checkPuzzle();
          }
        }
      } else if (e.key === "Backspace") {
        let r = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
        let c = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
        if (playerGrid[r][c] === "" && activeCellIndex > 0) {
          activeCellIndex--;
          r = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
          c = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);
        }
        playerGrid[r][c] = "";
        renderGrid();
        focusCell();
      } else if (["ArrowRight", "ArrowLeft", "ArrowUp", "ArrowDown"].includes(e.key)) {
        e.preventDefault();
        let newR = activeWord.row + (activeWord.dir === "down" ? activeCellIndex : 0);
        let newC = activeWord.col + (activeWord.dir === "across" ? activeCellIndex : 0);

        if (e.key === "ArrowRight") newC++;
        else if (e.key === "ArrowLeft") newC--;
        else if (e.key === "ArrowUp") newR--;
        else if (e.key === "ArrowDown") newR++;

        let newActiveWord = wordsMap.find(w =>
          newR >= w.row && newC >= w.col &&
          (w.dir === "across" ? newR === w.row && newC < w.col + w.word.length : newC === w.col && newR < w.row + w.word.length)
        );

        if (newActiveWord) {
          selectWord(newActiveWord);
          activeCellIndex = newActiveWord.word.split('').findIndex((char, i) => {
            let r = newActiveWord.row + (newActiveWord.dir === "down" ? i : 0);
            let c = newActiveWord.col + (newActiveWord.dir === "across" ? i : 0);
            return r === newR && c === newC;
          });
          focusCell();
        }
      }
    });

    function checkWordCompletion(wordObj) {
      let currentWordAttempt = '';
      for (let i = 0; i < wordObj.word.length; i++) {
        let r = wordObj.row + (wordObj.dir === "down" ? i : 0);
        let c = wordObj.col + (wordObj.dir === "across" ? i : 0);
        currentWordAttempt += playerGrid[r][c] || '';
      }

      if (currentWordAttempt.toLowerCase() === wordObj.word.toLowerCase() && !wordObj.solved) {
        wordObj.solved = true;
        currentPuzzleWordsCompleted++;
        currentPuzzleScore += 10;
        updateHUD();
        showFade(`Word "${wordObj.word.toUpperCase()}" Solved!`);
        if (wordsMap.every(w => w.solved)) {
          handlePuzzleEnd(true);
        }
      }
    }

    function checkPuzzle() {
      let allCorrect = true;
      for (const wordObj of wordsMap) {
        let currentWordAttempt = '';
        for (let i = 0; i < wordObj.word.length; i++) {
          let r = wordObj.row + (wordObj.dir === "down" ? i : 0);
          let c = wordObj.col + (wordObj.dir === "across" ? i : 0);
          currentWordAttempt += playerGrid[r][c] || '';
        }
        if (currentWordAttempt.toLowerCase() !== wordObj.word.toLowerCase()) {
          allCorrect = false;
          break;
        }
      }

      if (allCorrect) {
        handlePuzzleEnd(true);
      } else {
        showFade("Some words are incorrect. Keep trying!");
      }
    }

    function revealPuzzle() {
      if (gameOver) return;
      clearInterval(timerInterval);
      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
          if (solutionGrid[r][c] !== "") {
            playerGrid[r][c] = solutionGrid[r][c];
          }
        }
      }
      renderGrid();
      showFade("Puzzle Revealed!");
      setTimeout(() => {
        handlePuzzleEnd(false);
      }, 2000);
    }

    function useHint() {
      if (gameOver) return;
      let unsolvedWords = wordsMap.filter(w => !w.solved);
      if (unsolvedWords.length === 0) {
        showFade("All words are already solved!");
        return;
      }

      let wordToHint = unsolvedWords[Math.floor(Math.random() * unsolvedWords.length)];

      let hiddenLettersInWord = [];
      for (let i = 0; i < wordToHint.word.length; i++) {
        let r = wordToHint.row + (wordToHint.dir === "down" ? i : 0);
        let c = wordToHint.col + (wordToHint.dir === "across" ? i : 0);
        if (playerGrid[r][c] === "" || playerGrid[r][c].toLowerCase() !== wordToHint.word[i].toLowerCase()) {
          hiddenLettersInWord.push({ r, c, letter: wordToHint.word[i] });
        }
      }

      if (hiddenLettersInWord.length === 0) {
        wordToHint.solved = true;
        currentPuzzleWordsCompleted++;
        currentPuzzleScore += 10;
        updateHUD();
        useHint();
        return;
      }

      let hintCell = hiddenLettersInWord[Math.floor(Math.random() * hiddenLettersInWord.length)];
      playerGrid[hintCell.r][hintCell.c] = hintCell.letter;
      renderGrid();
      selectWord(wordToHint);

      let penalty = 0;
      if (!freeHintUsed) {
        freeHintUsed = true;
        showFade(`🆓 Free hint! "${hintCell.letter.toUpperCase()}" revealed in "${wordToHint.word.toUpperCase()}"`);
      } else {
        if (currentDifficulty === 'kids') penalty = 3;
        else if (currentDifficulty === 'easy') penalty = 5;
        else if (currentDifficulty === 'medium') penalty = 7;
        else penalty = 15;

        currentPuzzleScore -= penalty;
        if (currentPuzzleScore < 0) currentPuzzleScore = 0;
        updateHUD();
        showFade(`⚠️ Hint used! -${penalty} points. "${hintCell.letter.toUpperCase()}" revealed in "${wordToHint.word.toUpperCase()}"`);
      }
      checkWordCompletion(wordToHint);
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderLeaderboard();
      setTheme(darkToggle.checked ? 'dark' : 'light');
    });

    let lastClickedCell = null;

    document.addEventListener("click", function(event) {
      if (event.target.classList.contains("cell") && !event.target.classList.contains("black")) {
        lastClickedCell = event.target;
      }
    });

    document.addEventListener("keydown", function(event) {
      if (lastClickedCell && (event.key === "Backspace" || event.key === "Delete")) {
        event.preventDefault();
        lastClickedCell.textContent = "";
      }
    });
  </script>
</body>
</html>
